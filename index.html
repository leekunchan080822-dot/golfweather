<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>711 å°ˆæ¥­ç‰ˆ V2ï½œå…¨å°é«˜çˆ¾å¤«çƒå ´ç²¾æº–å¤©æ°£é å ±ï¼ˆECMWFï¼‰</title>

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f5f7fa;margin:0;padding:15px;}
.header-info{text-align:center;font-size:14px;color:#555;}
h2{text-align:center;margin:10px 0;}
.region-buttons{text-align:center;margin:15px 0;}
.region-buttons button{margin:4px;padding:6px 12px;border-radius:20px;border:1px solid #ccc;background:white;cursor:pointer;font-size:13px;}
.region-buttons button.active{background:#111;color:white;border-color:#111;}
.region-title{font-size:18px;font-weight:bold;margin:25px 0 10px;}
.card{background:white;border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 3px 10px rgba(0,0,0,0.08);}
.day-block{font-size:13px;margin-top:6px;padding-top:6px;border-top:1px solid #eee;}
.rain-high{color:red;font-weight:bold;}
.wind-high{color:#d97706;font-weight:bold;}
.gust-high{color:#b91c1c;font-weight:bold;}
.error{color:red;}
.toggle-btn{font-size:12px;padding:4px 8px;border-radius:6px;border:1px solid #ccc;background:#f8f8f8;cursor:pointer;}
small{color:#777;}
</style>
</head>

<body>

<div class="header-info" id="dateInfo"></div>
<div class="header-info">è³‡æ–™ä¾†æºï¼šOpen-Meteo ECMWF æ¨¡å‹ï½œé€å°æ™‚æ ¼é»é å ±</div>
<h2>711 å°ˆæ¥­ç‰ˆ V2ï½œå…¨å°é«˜çˆ¾å¤«çƒå ´ 7 æ—¥ç²¾æº–é å ±ï¼ˆé¢¨é€Ÿï¼‹é›¨é‡å¼·åŒ–ç‰ˆï¼‰</h2>

<div class="region-buttons" id="regionButtons"></div>
<div id="courses">è¼‰å…¥ä¸­...</div>

<script>

/* ===== æ—¥æœŸ ===== */
const today=new Date();
document.getElementById("dateInfo").innerText=
"è³‡æ–™æ›´æ–°æ™‚é–“ï¼š"+today.toLocaleString();

/* ===== æ˜ŸæœŸ ===== */
function getWeekday(dateStr){
    const d=new Date(dateStr);
    const arr=["é€±æ—¥","é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­"];
    return arr[d.getDay()];
}

/* ===== å…¨å°é«˜çˆ¾å¤«çƒå ´å®Œæ•´ç¶“ç·¯åº¦æ¸…å–® ===== */
const courses = [

/* å°åŒ— / æ–°åŒ— */
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"ç¿¡ç¿ é«˜çˆ¾å¤«çƒå ´", lat:25.0679, lon:121.4543 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"é»ƒé‡‘æµ·å²¸ï¼ˆåŒ—æµ·ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:25.2901, lon:121.5378 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"æ¿±æµ·é«˜çˆ¾å¤«ä¿±æ¨‚éƒ¨", lat:25.2517, lon:121.5195 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"å°ç£ï¼ˆè€æ·¡æ°´ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:25.1964, lon:121.4415 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"å¤§å±¯é«˜çˆ¾å¤«çƒå ´", lat:25.2023, lon:121.5298 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"æ®çš‡ï¼ˆæ–°æ·¡æ°´ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:25.2191, lon:121.4472 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"æ—å£é«˜çˆ¾å¤«çƒå ´", lat:25.0863, lon:121.3657 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"å…«é‡Œåœ‹éš›é«˜çˆ¾å¤«çƒå ´", lat:25.1427, lon:121.3998 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"ç¾éº—è¯é«˜çˆ¾å¤«çƒå ´", lat:25.1085, lon:121.5332 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"å¹¸ç¦é«˜çˆ¾å¤«çƒå ´", lat:25.1815, lon:121.4376 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"æ±è¯é«˜çˆ¾å¤«çƒå ´", lat:25.0962, lon:121.6033 },

/* æ¡ƒåœ’ */
{ region:"æ¡ƒåœ’", name:"å°åŒ—é«˜çˆ¾å¤«çƒå ´", lat:25.0124, lon:121.3005 },
{ region:"æ¡ƒåœ’", name:"çµ±å¸¥é«˜çˆ¾å¤«çƒå ´", lat:24.9967, lon:121.2831 },
{ region:"æ¡ƒåœ’", name:"é•·åºšé«˜çˆ¾å¤«çƒå ´", lat:25.0582, lon:121.3869 },
{ region:"æ¡ƒåœ’", name:"æ±æ–¹é«˜çˆ¾å¤«çƒå ´", lat:24.9463, lon:121.2924 },
{ region:"æ¡ƒåœ’", name:"ç¬¬ä¸€é«˜çˆ¾å¤«çƒå ´", lat:24.9538, lon:121.2437 },
{ region:"æ¡ƒåœ’", name:"æ°¸æ¼¢é«˜çˆ¾å¤«çƒå ´", lat:24.8942, lon:121.2715 },
{ region:"æ¡ƒåœ’", name:"æ¡ƒåœ’é«˜çˆ¾å¤«çƒå ´", lat:25.0247, lon:121.2859 },
{ region:"æ¡ƒåœ’", name:"å¤§æºªé«˜çˆ¾å¤«çƒå ´", lat:24.8837, lon:121.2806 },
{ region:"æ¡ƒåœ’", name:"é¾æ½­é«˜çˆ¾å¤«çƒå ´", lat:24.8634, lon:121.2187 },
{ region:"æ¡ƒåœ’", name:"æšæ˜‡é«˜çˆ¾å¤«é„‰æ‘ä¿±æ¨‚éƒ¨", lat:24.8578, lon:121.1964 },

/* èŠ±æ± */
{ region:"èŠ±æ±", name:"ç¤æºªé«˜çˆ¾å¤«çƒå ´", lat:24.8124, lon:121.7501 },
{ region:"èŠ±æ±", name:"èŠ±è“®é«˜çˆ¾å¤«çƒå ´", lat:23.9917, lon:121.6018 },

/* æ–°ç«¹ / è‹—æ — */
{ region:"æ–°ç«¹ / è‹—æ —", name:"å†èˆˆé«˜çˆ¾å¤«çƒå ´", lat:24.7893, lon:121.0234 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"æ–°ç«¹ï¼ˆæ–°è±ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:24.8884, lon:120.9871 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"æ±æ–¹ä¹‹æ˜Ÿé«˜çˆ¾å¤«çƒå ´", lat:24.5418, lon:120.8724 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"ç«‹ç›Šé«˜çˆ¾å¤«çƒå ´", lat:24.5207, lon:120.8822 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"æ—­é™½é«˜çˆ¾å¤«çƒå ´", lat:24.4693, lon:120.8438 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"è€çˆºé—œè¥¿é«˜çˆ¾å¤«çƒå ´", lat:24.7986, lon:121.1777 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"å±±æºªåœ°é«˜çˆ¾å¤«çƒå ´", lat:24.4845, lon:120.9027 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"å¯¶å±±é«˜çˆ¾å¤«çƒå ´", lat:24.7422, lon:120.9853 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"çš‡å®¶é«˜çˆ¾å¤«çƒå ´", lat:24.6127, lon:120.8611 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"å…¨åœ‹é«˜çˆ¾å¤«çƒå ´", lat:24.5754, lon:120.8149 },

/* å°ä¸­ / å½°åŒ– / å—æŠ• */
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", name:"æ¸…æ³‰å´—é«˜çˆ¾å¤«çƒå ´", lat:24.2102, lon:120.6041 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", name:"è±åŸé«˜çˆ¾å¤«çƒå ´", lat:24.2667, lon:120.7173 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", name:"å°ä¸­åœ‹éš›é«˜çˆ¾å¤«çƒå ´", lat:24.1715, lon:120.7276 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", name:"éœ§å³°é«˜çˆ¾å¤«çƒå ´", lat:24.0641, lon:120.7009 },

/* å˜‰ç¾© / å°å— / é«˜é›„ / å±æ± */
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"æ£•æ¢ æ¹–ï¼ˆæ±æ´‹ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:23.4702, lon:120.4024 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"æ–‘èŠèŠ±é«˜çˆ¾å¤«ä¿±æ¨‚éƒ¨", lat:23.0168, lon:120.4057 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"å˜‰å…‰é«˜çˆ¾å¤«çƒå ´", lat:23.4859, lon:120.4308 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"å°å—é«˜çˆ¾å¤«çƒå ´ï¼ˆæ–°åŒ–ï¼‰", lat:23.0384, lon:120.3205 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"å—ä¸€é«˜çˆ¾å¤«çƒå ´", lat:23.1438, lon:120.4037 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"å—å¯¶é«˜çˆ¾å¤«çƒå ´", lat:23.1025, lon:120.3268 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"å¤§å´—å±±é«˜çˆ¾å¤«çƒå ´", lat:22.8533, lon:120.3542 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"ä¿¡èª¼é«˜çˆ¾å¤«çƒå ´", lat:22.7245, lon:120.3894 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"è§€éŸ³å±±é«˜çˆ¾å¤«çƒå ´", lat:22.7416, lon:120.3557 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"å±æ±é«˜çˆ¾å¤«çƒå ´", lat:22.6694, lon:120.4882 }

];

/* ===== ç²¾æº– ECMWF API ===== */
async function getWeeklyWeather(lat,lon){

    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation_probability,precipitation,windspeed_10m,windgusts_10m&daily=temperature_2m_max,temperature_2m_min&forecast_days=7&timezone=Asia/Taipei`;

    try{
        const res=await fetch(url);
        const data=await res.json();

        const hourly=data.hourly;
        const daily=data.daily;

        const results=[];

        for(let d=0;d<7;d++){

            const date=daily.time[d];
            const morning=[];
            const afternoon=[];

            hourly.time.forEach((t,i)=>{
                if(t.startsWith(date)){
                    const h=parseInt(t.substring(11,13));
                    if(h>=8&&h<12) morning.push(i);
                    if(h>=12&&h<18) afternoon.push(i);
                }
            });

            const avg=(arr,key)=>
                arr.length?Math.round(arr.reduce((s,i)=>s+hourly[key][i],0)/arr.length):0;

            results.push({
                date,
                weekday:getWeekday(date),
                minT:daily.temperature_2m_min[d],
                maxT:daily.temperature_2m_max[d],

                popMorning:avg(morning,"precipitation_probability"),
                popAfternoon:avg(afternoon,"precipitation_probability"),

                rainMorning:avg(morning,"precipitation"),
                rainAfternoon:avg(afternoon,"precipitation"),

                windMorning:avg(morning,"windspeed_10m"),
                windAfternoon:avg(afternoon,"windspeed_10m"),

                gustMorning:avg(morning,"windgusts_10m"),
                gustAfternoon:avg(afternoon,"windgusts_10m")
            });
        }

        return {forecasts:results};

    }catch(e){
        console.log(e);
        return {error:true};
    }
}

/* ===== UI æ§åˆ¶ ===== */
let weatherCache={};

function createRegionButtons(){
    const regions=["å…¨éƒ¨",...new Set(courses.map(c=>c.region))];
    const container=document.getElementById("regionButtons");
    container.innerHTML="";
    regions.forEach(r=>{
        const btn=document.createElement("button");
        btn.innerText=r;
        btn.onclick=()=>filterRegion(r);
        container.appendChild(btn);
    });
    container.firstChild.classList.add("active");
}

function filterRegion(selected){
    document.querySelectorAll(".region-buttons button").forEach(btn=>{
        btn.classList.toggle("active",btn.innerText===selected);
    });
    renderCourses(selected);
}

/* ===== è¼‰å…¥ ===== */
async function loadCourses(){

    await Promise.all(
        courses.map(async c=>{
            weatherCache[c.name]=await getWeeklyWeather(c.lat,c.lon);
        })
    );

    createRegionButtons();
    renderCourses("å…¨éƒ¨");
}

/* ===== æ¸²æŸ“ ===== */
function renderCourses(filter="å…¨éƒ¨"){

    let html="";

    const filtered=filter==="å…¨éƒ¨"?courses:courses.filter(c=>c.region===filter);

    const grouped=filtered.reduce((acc,c)=>{
        if(!acc[c.region]) acc[c.region]=[];
        acc[c.region].push(c);
        return acc;
    },{});

    for(const region in grouped){

        html+=`<div class="region-title">${region}</div>`;

        grouped[region].forEach((course,index)=>{

            const w=weatherCache[course.name];

            if(!w||w.error){
                html+=`<div class="card"><strong>${course.name}</strong><div class="error">è®€å–å¤±æ•—</div></div>`;
                return;
            }

            const cardId=`card_${region}_${index}`.replace(/\s/g,'');

            let forecastHTML="";

            w.forecasts.forEach((f,i)=>{

                const hidden=i>=2?"display:none;":"";

                const rainClassMorning=f.rainMorning>=0.5?"rain-high":"";
                const rainClassAfternoon=f.rainAfternoon>=0.5?"rain-high":"";

                const windClassMorning=f.windMorning>=25?"wind-high":"";
                const windClassAfternoon=f.windAfternoon>=25?"wind-high":"";

                const gustClassMorning=f.gustMorning>=35?"gust-high":"";
                const gustClassAfternoon=f.gustAfternoon>=35?"gust-high":"";

                forecastHTML+=`
                <div class="day-block extra-day" style="${hidden}">
                <strong>${f.date}ï¼ˆ${f.weekday}ï¼‰</strong><br>
                æº«åº¦ ${f.minT}Â°C - ${f.maxT}Â°C<br>

                08â€“12ï½œ
                â˜” <span class="${rainClassMorning}">${f.rainMorning}mm (${f.popMorning}%)</span>ï½œ
                ğŸŒ¬ <span class="${windClassMorning}">${f.windMorning}km/h</span>ï½œ
                ğŸ’¨ <span class="${gustClassMorning}">é™£é¢¨ ${f.gustMorning}</span><br>

                12â€“18ï½œ
                â˜” <span class="${rainClassAfternoon}">${f.rainAfternoon}mm (${f.popAfternoon}%)</span>ï½œ
                ğŸŒ¬ <span class="${windClassAfternoon}">${f.windAfternoon}km/h</span>ï½œ
                ğŸ’¨ <span class="${gustClassAfternoon}">é™£é¢¨ ${f.gustAfternoon}</span>
                </div>`;
            });

            forecastHTML+=`
            <div style="text-align:right;margin-top:6px;">
                <button class="toggle-btn" onclick="toggleForecast('${cardId}',this)">å±•é–‹</button>
            </div>`;

            html+=`
            <div class="card" id="${cardId}">
                <strong>${course.name}</strong><br>
                <small>åº§æ¨™ï¼š${course.lat}, ${course.lon}</small>
                ${forecastHTML}
            </div>`;
        });
    }

    document.getElementById("courses").innerHTML=html;
}

/* ===== å±•é–‹æ”¶åˆ ===== */
function toggleForecast(cardId,btn){
    const card=document.getElementById(cardId);
    const extra=card.querySelectorAll(".extra-day");
    const hidden=extra[2]?.style.display==="none";
    extra.forEach((d,i)=>{
        if(i>=2) d.style.display=hidden?"block":"none";
    });
    btn.innerText=hidden?"æ”¶åˆ":"å±•é–‹";
}

loadCourses();

</script>
</body>
</html>
