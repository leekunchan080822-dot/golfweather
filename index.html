<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>711專用-全台高爾夫球場一週天氣預報</title>

<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background:#f5f7fa; margin:0; padding:15px;}
.header-info { text-align:center; font-size:14px; color:#555;}
h2 { text-align:center; margin:10px 0;}
.region-buttons { text-align:center; margin:15px 0;}
.region-buttons button { margin:4px; padding:6px 12px; border-radius:20px; border:1px solid #ccc; background:white; cursor:pointer; font-size:13px;}
.region-buttons button.active { background:#333; color:white; border-color:#333;}
.region-title { font-size:18px; font-weight:bold; margin:25px 0 10px;}
.card { background:white; border-radius:12px; padding:12px; margin-bottom:12px; box-shadow:0 3px 10px rgba(0,0,0,0.08);}
.day-block { font-size:13px; margin-top:6px; padding-top:6px; border-top:1px solid #eee;}
.rain-high { color:red; font-weight:bold;}
.error { color:red;}
.toggle-btn { font-size:12px; padding:4px 8px; border-radius:6px; border:1px solid #ccc; background:#f8f8f8; cursor:pointer;}
</style>
</head>

<body>

<div class="header-info" id="dateInfo"></div>
<div class="header-info">資料來源：中央氣象署（CWA）</div>
<h2>711專用-全台高爾夫球場一週天氣預報-坤戰閒暇製作不准就不准(紅字代表降雨機率大於 60%)</h2>

<div class="region-buttons" id="regionButtons"></div>
<div id="courses">載入中...</div>

<script>

/* 日期 */
const today = new Date();
document.getElementById("dateInfo").innerText =
"資料更新日期：" + today.getFullYear()+"/"+(today.getMonth()+1).toString().padStart(2,"0")+"/"+today.getDate().toString().padStart(2,"0");

/* API KEY */
const API_KEY = "CWA-60E4630E-A677-453A-BD76-C74F148C86ED";

/* 台轉臺 */
function normalizeCity(city){
    return city.replace("台","臺");
}

/* 星期 */
function getWeekday(dateStr){
    const d = new Date(dateStr);
    const arr = ["週日","週一","週二","週三","週四","週五","週六"];
    return arr[d.getDay()];
}

/* 球場清單（可自行完整擴充） */
const courses = [
{ region:"台北市 / 新北市", name:"翡翠高爾夫球場", city:"新北市" },
{ region:"台北市 / 新北市", name:"黃金海岸（北海）高爾夫球場", city:"新北市" },
{ region:"台北市 / 新北市", name:"濱海高爾夫俱樂部", city:"新北市" },
{ region:"台北市 / 新北市", name:"台灣（老淡水）高爾夫球場", city:"新北市" },
{ region:"台北市 / 新北市", name:"大屯高爾夫球場", city:"新北市" },
{ region:"台北市 / 新北市", name:"揮皇（新淡水）高爾夫球場", city:"新北市" },
{ region:"台北市 / 新北市", name:"林口高爾夫球場", city:"新北市" },
{ region:"台北市 / 新北市", name:"八里國際高爾夫球場", city:"新北市" },
{ region:"台北市 / 新北市", name:"美麗華高爾夫球場", city:"新北市" },
{ region:"台北市 / 新北市", name:"幸福高爾夫球場", city:"新北市" },
{ region:"台北市 / 新北市", name:"東華高爾夫球場", city:"新北市" },

{ region:"桃園", name:"台北高爾夫球場", city:"桃園市" },
{ region:"桃園", name:"統帥高爾夫球場", city:"桃園市" },
{ region:"桃園", name:"長庚高爾夫球場", city:"桃園市" },
{ region:"桃園", name:"東方高爾夫球場", city:"桃園市" },
{ region:"桃園", name:"第一高爾夫球場", city:"桃園市" },
{ region:"桃園", name:"永漢高爾夫球場", city:"桃園市" },
{ region:"桃園", name:"桃園高爾夫球場", city:"桃園市" },
{ region:"桃園", name:"大溪高爾夫球場", city:"桃園市" },
{ region:"桃園", name:"龍潭高爾夫球場", city:"桃園市" },
{ region:"桃園", name:"揚昇高爾夫鄉村俱樂部", city:"桃園市" },

{ region:"花東", name:"礁溪高爾夫球場", city:"宜蘭縣" },
{ region:"花東", name:"花蓮高爾夫球場", city:"花蓮縣" },

{ region:"新竹 / 苗栗", name:"再興高爾夫球場", city:"新竹縣" },
{ region:"新竹 / 苗栗", name:"新竹（新豐）高爾夫球場", city:"新竹縣" },
{ region:"新竹 / 苗栗", name:"東方之星高爾夫球場", city:"苗栗縣" },
{ region:"新竹 / 苗栗", name:"立益高爾夫球場", city:"苗栗縣" },
{ region:"新竹 / 苗栗", name:"旭陽高爾夫球場", city:"苗栗縣" },
{ region:"新竹 / 苗栗", name:"老爺關西高爾夫球場", city:"新竹縣" },
{ region:"新竹 / 苗栗", name:"山溪地高爾夫球場", city:"苗栗縣" },
{ region:"新竹 / 苗栗", name:"寶山高爾夫球場", city:"新竹縣" },
{ region:"新竹 / 苗栗", name:"皇家高爾夫球場", city:"苗栗縣" },
{ region:"新竹 / 苗栗", name:"全國高爾夫球場", city:"苗栗縣" },

{ region:"台中 / 彰化 / 南投", name:"清泉崗高爾夫球場", city:"臺中市" },
{ region:"台中 / 彰化 / 南投", name:"豐原高爾夫球場", city:"臺中市" },
{ region:"台中 / 彰化 / 南投", name:"台中國際高爾夫球場", city:"臺中市" },
{ region:"台中 / 彰化 / 南投", name:"霧峰高爾夫球場", city:"臺中市" },

{ region:"嘉義 / 台南 / 高雄 / 屏東", name:"棕梠湖（東洋）高爾夫球場", city:"嘉義縣" },
{ region:"嘉義 / 台南 / 高雄 / 屏東", name:"斑芝花高爾夫俱樂部", city:"臺南市" },
{ region:"嘉義 / 台南 / 高雄 / 屏東", name:"嘉光高爾夫球場", city:"嘉義市" },
{ region:"嘉義 / 台南 / 高雄 / 屏東", name:"台南高爾夫球場（新化）", city:"臺南市" },
{ region:"嘉義 / 台南 / 高雄 / 屏東", name:"南一高爾夫球場", city:"臺南市" },
{ region:"嘉義 / 台南 / 高雄 / 屏東", name:"南寶高爾夫球場", city:"臺南市" },
{ region:"嘉義 / 台南 / 高雄 / 屏東", name:"大崗山高爾夫球場", city:"高雄市" },
{ region:"嘉義 / 台南 / 高雄 / 屏東", name:"信誼高爾夫球場", city:"高雄市" },
{ region:"嘉義 / 台南 / 高雄 / 屏東", name:"觀音山高爾夫球場", city:"高雄市" },
{ region:"嘉義 / 台南 / 高雄 / 屏東", name:"屏東高爾夫球場", city:"屏東縣" }
];

/* ===== 天氣 API 解析（08–12 / 12–18 分開） ===== */
async function getWeeklyWeather(city){

    city = normalizeCity(city);

    const url =
    `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-D0047-091?Authorization=${API_KEY}&LocationName=${city}`;

    try{
        const res = await fetch(url);
        const data = await res.json();

        if(!data.records?.Locations?.length) return {error:true};

        const location = data.records.Locations[0].Location[0];
        const elements = location.WeatherElement;

        const weatherTimes = elements.find(e=>e.ElementName==="天氣現象").Time;
        const popTimes     = elements.find(e=>e.ElementName==="12小時降雨機率").Time;
        const maxT         = elements.find(e=>e.ElementName==="最高溫度").Time;
        const minT         = elements.find(e=>e.ElementName==="最低溫度").Time;

        let daily = {};

        weatherTimes.forEach((w,i)=>{

            const start = w.StartTime;
            const end   = w.EndTime;
            const date  = start.substring(0,10);

            if(!daily[date]){
                daily[date] = {
                    weather: w.ElementValue[0].Weather,
                    popMorning: 0,
                    popAfternoon: 0,
                    maxT: 0,
                    minT: 100
                };
            }

            const rainRaw = popTimes[i]?.ElementValue[0]?.ProbabilityOfPrecipitation;
            const rainVal = isNaN(parseInt(rainRaw)) ? 0 : parseInt(rainRaw);

            const startHour = parseInt(start.substring(11,13));
            const endHour   = parseInt(end.substring(11,13));

            // 00–12 對應 08–12
            if(startHour === 0 && endHour === 12){
                daily[date].popMorning = rainVal;
            }

            // 12–24 對應 12–18
            if(startHour === 12){
                daily[date].popAfternoon = rainVal;
            }

            daily[date].maxT = Math.max(daily[date].maxT, parseInt(maxT[i].ElementValue[0].MaxTemperature));
            daily[date].minT = Math.min(daily[date].minT, parseInt(minT[i].ElementValue[0].MinTemperature));

        });

        const forecasts = Object.keys(daily).slice(0,7).map(date=>({
            date,
            weekday:getWeekday(date),
            weather: daily[date].weather,
            popMorning: daily[date].popMorning,
            popAfternoon: daily[date].popAfternoon,
            maxT: daily[date].maxT,
            minT: daily[date].minT
        }));

        return {forecasts};

    }catch(e){
        return {error:true};
    }
}

/* ===== 區域按鈕 ===== */
function createRegionButtons(){
    const regions = ["全部", ...new Set(courses.map(c=>c.region))];
    const container = document.getElementById("regionButtons");
    container.innerHTML = "";

    regions.forEach(region=>{
        const btn = document.createElement("button");
        btn.innerText = region;
        btn.onclick = () => filterRegion(region);
        container.appendChild(btn);
    });

    container.firstChild.classList.add("active");
}

function filterRegion(selected){
    const buttons = document.querySelectorAll(".region-buttons button");
    buttons.forEach(btn=>{
        btn.classList.remove("active");
        if(btn.innerText === selected){
            btn.classList.add("active");
        }
    });
    renderCourses(selected);
}

/* ===== UI ===== */
let weatherCache={};

async function loadCourses(){

    const cities=[...new Set(courses.map(c=>c.city))];

    await Promise.all(
        cities.map(async city=>{
            weatherCache[city]=await getWeeklyWeather(city);
        })
    );

    createRegionButtons();
    renderCourses("全部");
}

function renderCourses(filter="全部"){

    let html="";

    const filteredCourses = filter==="全部"
        ? courses
        : courses.filter(c=>c.region===filter);

    const grouped = filteredCourses.reduce((acc,course)=>{
        if(!acc[course.region]) acc[course.region]=[];
        acc[course.region].push(course);
        return acc;
    },{});

    for(const region in grouped){

        html+=`<div class="region-title">${region}</div>`;

        grouped[region].forEach((course,index)=>{

            const w=weatherCache[course.city];

            if(!w || w.error){
                html+=`<div class="card"><strong>${course.name}</strong><div class="error">讀取失敗</div></div>`;
            }else{

                let forecastHTML="";
                const cardId = `card_${region}_${index}`.replace(/\s/g,'');

                w.forecasts.forEach((f,i)=>{

                    const rainClassMorning = f.popMorning>60?"rain-high":"";
                    const rainClassAfternoon = f.popAfternoon>60?"rain-high":"";
                    const hiddenStyle = i>=2 ? "display:none;" : "";

                    forecastHTML+=`
                    <div class="day-block extra-day" style="${hiddenStyle}">
                    ${f.date}（${f.weekday}）｜
                    ${f.weather}｜
                    ${f.minT}°C-${f.maxT}°C｜
                    <span class="${rainClassMorning}">08–12 ${f.popMorning}%</span>｜
                    <span class="${rainClassAfternoon}">12–18 ${f.popAfternoon}%</span>
                    </div>`;
                });

                forecastHTML+=`
                <div style="text-align:right; margin-top:6px;">
                    <button class="toggle-btn" onclick="toggleForecast('${cardId}', this)">展開</button>
                </div>`;

                html+=`<div class="card" id="${cardId}">
                        <strong>${course.name}</strong>
                        ${forecastHTML}
                       </div>`;
            }

        });
    }

    document.getElementById("courses").innerHTML=html;
}

function toggleForecast(cardId, btn){

    const card = document.getElementById(cardId);
    const extraDays = card.querySelectorAll(".extra-day");

    const isHidden = extraDays[2]?.style.display === "none";

    extraDays.forEach((day,i)=>{
        if(i>=2){
            day.style.display = isHidden ? "block" : "none";
        }
    });

    btn.innerText = isHidden ? "收合" : "展開";
}

loadCourses();

</script>
</body>
</html>
