<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¨å°é«˜çˆ¾å¤«çƒå ´å¤©æ°£é å ± 2026 PRO</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f5f7fa;
  margin:0;
  padding:15px;
}
.header-info{text-align:center;font-size:14px;color:#555;}
h2{text-align:center;margin:10px 0;}
button{
  margin:4px;
  padding:6px 12px;
  border-radius:20px;
  border:1px solid #ccc;
  background:white;
  cursor:pointer;
  font-size:13px;
}
button.active{background:#111;color:white;border-color:#111;}
.region-title{font-size:18px;font-weight:bold;margin:25px 0 10px;}
.card{
  background:white;
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
  box-shadow:0 3px 10px rgba(0,0,0,0.08);
}
.day-block{
  font-size:13px;
  margin-top:6px;
  padding-top:6px;
  border-top:1px solid #eee;
  line-height:1.6;
}
.toggle-btn{
  font-size:12px;
  padding:4px 8px;
  border-radius:6px;
  border:1px solid #ccc;
  background:#f8f8f8;
  cursor:pointer;
}
.map-link{
  font-size:12px;
  color:#2563eb;
  text-decoration:none;
  margin-left:8px;
}
.loading{text-align:center;padding:20px;color:#666;}
</style>
</head>

<body>

<div class="header-info" id="dateInfo"></div>
<h2>å…¨å°é«˜çˆ¾å¤«çƒå ´ç²¾æº–å¤©æ°£é å ± 2026 PRO</h2>

<div style="text-align:center;margin-bottom:12px;" id="modelButtons"></div>
<div style="text-align:center;margin-bottom:12px;" id="regionButtons"></div>
<div id="courses" class="loading">è¼‰å…¥ä¸­...</div>

<script>

const CWA_KEY="CWA-60E4630E-A677-453A-BD76-C74F148C86ED"; 
let currentModel="ECMWF";
let lastRegion="å…¨éƒ¨";
let cwaRaw=null;

document.getElementById("dateInfo").innerText =
"è³‡æ–™æ›´æ–°æ™‚é–“ï¼š"+new Date().toLocaleString();

function getWeekday(dateStr){
  const d=new Date(dateStr);
  return ["é€±æ—¥","é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­"][d.getDay()];
}

/* ========= çƒå ´è³‡æ–™ï¼ˆä¿ç•™ä½ åŸæœ¬å®Œæ•´æ¸…å–®ï¼‰ ========= */
const courses=[
/* å°åŒ— / æ–°åŒ— */
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"ç¿¡ç¿ é«˜çˆ¾å¤«çƒå ´", lat:25.18733, lon:121.68351 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"é»ƒé‡‘æµ·å²¸é«˜çˆ¾å¤«çƒå ´", lat:25.29175, lon:121.57945 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"æ¿±æµ·é«˜çˆ¾å¤«ä¿±æ¨‚éƒ¨", lat:25.28114, lon:121.54716 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"å°ç£ï¼ˆè€æ·¡æ°´ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:25.17646, lon:121.43094 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"å¤§å±¯é«˜çˆ¾å¤«çƒå ´", lat:25.18641, lon:121.46332 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"æ®çš‡ï¼ˆæ–°æ·¡æ°´ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:25.19561, lon:121.46114 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"æ—å£é«˜çˆ¾å¤«çƒå ´", lat:25.09311, lon:121.34107 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"å…«é‡Œåœ‹éš›é«˜çˆ¾å¤«çƒå ´", lat:25.10971, lon:121.36531 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"ç¾éº—è¯é«˜çˆ¾å¤«çƒå ´", lat:25.10174, lon:121.37314 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"å¹¸ç¦é«˜çˆ¾å¤«çƒå ´", lat:25.11142, lon:121.34418 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"æ±è¯é«˜çˆ¾å¤«çƒå ´", lat:25.11937, lon:121.32531 },

/* æ¡ƒåœ’ */
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"å°åŒ—é«˜çˆ¾å¤«çƒå ´", lat:25.06045, lon:121.32608 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"çµ±å¸¥é«˜çˆ¾å¤«çƒå ´", lat:25.05141, lon:121.32441 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"é•·åºšé«˜çˆ¾å¤«çƒå ´", lat:25.05032, lon:121.37892 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"æ±æ–¹é«˜çˆ¾å¤«çƒå ´", lat:25.05667, lon:121.34861 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"ç¬¬ä¸€é«˜çˆ¾å¤«çƒå ´", lat:25.07416, lon:121.28055 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"æ°¸æ¼¢é«˜çˆ¾å¤«çƒå ´", lat:25.09917, lon:121.28252 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"æ¡ƒåœ’é«˜çˆ¾å¤«çƒå ´", lat:24.89832, lon:121.21805 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"å¤§æºªé«˜çˆ¾å¤«çƒå ´", lat:24.84361, lon:121.28112 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"é¾æ½­é«˜çˆ¾å¤«çƒå ´", lat:24.83888, lon:121.21638 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"æšæ˜‡é«˜çˆ¾å¤«é„‰æ‘ä¿±æ¨‚éƒ¨", lat:24.87221, lon:121.14446 },

/* å®œè˜­ / èŠ±è“® */
{ region:"èŠ±æ±", city:"å®œè˜­ç¸£", name:"ç¤æºªé«˜çˆ¾å¤«çƒå ´", lat:24.81622, lon:121.72211 },
{ region:"èŠ±æ±", city:"èŠ±è“®ç¸£", name:"èŠ±è“®é«˜çˆ¾å¤«çƒå ´", lat:23.99861, lon:121.63113 },

/* æ–°ç«¹ / è‹—æ — */
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"å†èˆˆé«˜çˆ¾å¤«çƒå ´", lat:24.88722, lon:121.03752 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"æ–°ç«¹ï¼ˆæ–°è±ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:24.89751, lon:120.97888 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"è‹—æ —ç¸£", name:"æ±æ–¹ä¹‹æ˜Ÿé«˜çˆ¾å¤«çƒå ´", lat:24.71167, lon:121.05055 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"ç«‹ç›Šé«˜çˆ¾å¤«çƒå ´", lat:24.78667, lon:121.20639 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"æ—­é™½é«˜çˆ¾å¤«çƒå ´", lat:24.78112, lon:121.22694 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"è€çˆºé—œè¥¿é«˜çˆ¾å¤«çƒå ´", lat:24.78056, lon:121.18944 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"å±±æºªåœ°é«˜çˆ¾å¤«çƒå ´", lat:24.79333, lon:121.19222 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"å¯¶å±±é«˜çˆ¾å¤«çƒå ´", lat:24.73972, lon:121.02639 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"è‹—æ —ç¸£", name:"çš‡å®¶é«˜çˆ¾å¤«çƒå ´", lat:24.58278, lon:120.89306 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"è‹—æ —ç¸£", name:"å…¨åœ‹é«˜çˆ¾å¤«çƒå ´", lat:24.39472, lon:120.76055 },

/* å°ä¸­ / å½°åŒ– / å—æŠ• */
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", city:"è‡ºä¸­å¸‚", name:"æ¸…æ³‰å´—é«˜çˆ¾å¤«çƒå ´", lat:24.25472, lon:120.61862 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", city:"è‡ºä¸­å¸‚", name:"è±åŸé«˜çˆ¾å¤«çƒå ´", lat:24.24833, lon:120.75112 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", city:"è‡ºä¸­å¸‚", name:"å°ä¸­åœ‹éš›é«˜çˆ¾å¤«çƒå ´", lat:24.18445, lon:120.75222 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", city:"è‡ºä¸­å¸‚", name:"éœ§å³°é«˜çˆ¾å¤«çƒå ´", lat:24.03528, lon:120.73028 },

/* å˜‰ç¾© / å°å— / é«˜é›„ / å±æ± */
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"å˜‰ç¾©ç¸£", name:"æ£•æ¢ æ¹–é«˜çˆ¾å¤«çƒå ´", lat:23.44751, lon:120.52834 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"è‡ºå—å¸‚", name:"æ–‘èŠèŠ±é«˜çˆ¾å¤«ä¿±æ¨‚éƒ¨", lat:23.23806, lon:120.47889 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"å˜‰ç¾©ç¸£", name:"å˜‰å…‰é«˜çˆ¾å¤«çƒå ´", lat:23.47389, lon:120.47251 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"è‡ºå—å¸‚", name:"å°å—é«˜çˆ¾å¤«çƒå ´ï¼ˆæ–°åŒ–ï¼‰", lat:23.01888, lon:120.35806 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"è‡ºå—å¸‚", name:"å—ä¸€é«˜çˆ¾å¤«çƒå ´", lat:22.95528, lon:120.32112 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"è‡ºå—å¸‚", name:"å—å¯¶é«˜çˆ¾å¤«çƒå ´", lat:23.20167, lon:120.41306 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"é«˜é›„å¸‚", name:"å¤§å´—å±±é«˜çˆ¾å¤«çƒå ´", lat:22.84694, lon:120.38028 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"é«˜é›„å¸‚", name:"ä¿¡èª¼é«˜çˆ¾å¤«çƒå ´", lat:22.72140, lon:120.43556 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"é«˜é›„å¸‚", name:"è§€éŸ³å±±é«˜çˆ¾å¤«çƒå ´", lat:22.73028, lon:120.38111 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"å±æ±ç¸£", name:"å±æ±é«˜çˆ¾å¤«çƒå ´", lat:22.68056, lon:120.50527 }

];

/* ========= æŒ‰éˆ• ========= */

function buildModelButtons(){
  const container=document.getElementById("modelButtons");
  container.innerHTML="";
  ["ECMWF","CWA"].forEach(m=>{
    const btn=document.createElement("button");
    btn.innerText=m;
    if(m===currentModel) btn.classList.add("active");
    btn.onclick=()=>{
      currentModel=m;
      buildModelButtons();
      loadCourses(lastRegion);
    };
    container.appendChild(btn);
  });
}

function buildRegionButtons(){
  const regions=["å…¨éƒ¨",...new Set(courses.map(c=>c.region))];
  const container=document.getElementById("regionButtons");
  container.innerHTML="";
  regions.forEach(r=>{
    const btn=document.createElement("button");
    btn.innerText=r;
    if(r===lastRegion) btn.classList.add("active");
    btn.onclick=()=>{
      lastRegion=r;
      buildRegionButtons();
      loadCourses(r);
    };
    container.appendChild(btn);
  });
}

/* ========= ECMWF ========= */

async function getECMWF(lat,lon){

  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&models=ecmwf&hourly=temperature_2m,precipitation_probability,precipitation,wind_speed_10m,wind_gusts_10m&daily=temperature_2m_max,temperature_2m_min&forecast_days=7&timezone=Asia/Taipei`;

  const res=await fetch(url);
  const data=await res.json();

  const hourly=data.hourly;
  const daily=data.daily;

  const results=[];

  for(let d=0;d<daily.time.length;d++){

    const date=daily.time[d];
    const morning=[],afternoon=[];

    hourly.time.forEach((t,i)=>{
      if(t.startsWith(date)){
        const h=parseInt(t.substring(11,13));
        if(h>=8&&h<12) morning.push(i);
        if(h>=12&&h<18) afternoon.push(i);
      }
    });

    const avg=(arr,key)=>
      arr.length?Math.round(arr.reduce((s,i)=>s+hourly[key][i],0)/arr.length):0;

    const sum=(arr,key)=>
      arr.length?hourly[key].reduce((s,v,i)=>arr.includes(i)?s+v:s,0).toFixed(1):0;

    results.push({
      date,
      weekday:getWeekday(date),
      minT:daily.temperature_2m_min[d],
      maxT:daily.temperature_2m_max[d],
      popMorning:avg(morning,"precipitation_probability"),
      popAfternoon:avg(afternoon,"precipitation_probability"),
      rainMorning:sum(morning,"precipitation"),
      rainAfternoon:sum(afternoon,"precipitation"),
      windMorning:avg(morning,"wind_speed_10m"),
      windAfternoon:avg(afternoon,"wind_speed_10m"),
      gustMorning:avg(morning,"wind_gusts_10m"),
      gustAfternoon:avg(afternoon,"wind_gusts_10m")
    });
  }

  return results;
}

/* ========= CWA ========= */

async function getCWA(city){

  if(!cwaRaw){
    const url=`https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${CWA_KEY}&format=JSON`;
    const res=await fetch(url);
    cwaRaw=await res.json();
  }

  const normalizedCity = city.replaceAll("è‡º","å°");

  const loc=cwaRaw.records.location.find(l=>
    l.locationName.replaceAll("è‡º","å°")===normalizedCity
  );

  if(!loc) return [];

  const minT=loc.weatherElement.find(e=>e.elementName==="MinT").time;
  const maxT=loc.weatherElement.find(e=>e.elementName==="MaxT").time;
  const pop=loc.weatherElement.find(e=>e.elementName==="PoP").time;

  return minT.map((t,i)=>({
    date:t.startTime.split(" ")[0],
    weekday:getWeekday(t.startTime),
    minT:minT[i].parameter.parameterName,
    maxT:maxT[i].parameter.parameterName,
    popMorning:pop[i].parameter.parameterName,
    popAfternoon:pop[i].parameter.parameterName,
    rainMorning:null,
    rainAfternoon:null,
    windMorning:null,
    windAfternoon:null,
    gustMorning:null,
    gustAfternoon:null
  }));
}

/* ========= ä¸»æ¸²æŸ“ ========= */

async function loadCourses(region="å…¨éƒ¨"){

  document.getElementById("courses").innerHTML="<div class='loading'>è¼‰å…¥ä¸­...</div>";

  const filtered=region==="å…¨éƒ¨"?courses:courses.filter(c=>c.region===region);

  const promises = filtered.map(c =>
    currentModel==="ECMWF"
      ? getECMWF(c.lat,c.lon)
      : getCWA(c.city)
  );

  const allForecasts = await Promise.all(promises);

  let html="";

  filtered.forEach((c,index)=>{

    const forecasts=allForecasts[index];

    html+=`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>${c.name}</strong>
        <a class="map-link" target="_blank"
          href="https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lon}">
          å°èˆª
        </a>
      </div>`;

    forecasts.forEach((f,i)=>{

      const hidden=i>=2?"display:none;":"";

      html+=`
      <div class="day-block extra-day" style="${hidden}">
        <strong>${f.date}ï¼ˆ${f.weekday}ï¼‰</strong><br>
        æº«åº¦ ${f.minT}Â°C - ${f.maxT}Â°C<br>`;

      if(currentModel==="ECMWF"){
        html+=`
        08â€“12ï½œ
        â˜” ${f.rainMorning}mm (${f.popMorning}%)ï½œ
        ğŸŒ¬ ${f.windMorning}km/hï½œ
        ğŸ’¨ é™£é¢¨ ${f.gustMorning}km/h<br>

        12â€“18ï½œ
        â˜” ${f.rainAfternoon}mm (${f.popAfternoon}%)ï½œ
        ğŸŒ¬ ${f.windAfternoon}km/hï½œ
        ğŸ’¨ é™£é¢¨ ${f.gustAfternoon}km/h`;
      }else{
        html+=`é™é›¨æ©Ÿç‡ ${f.popMorning}%`;
      }

      html+=`</div>`;
    });

    html+=`
      <div style="text-align:right;margin-top:6px;">
        <button class="toggle-btn" onclick="toggleForecast(this)">å±•é–‹</button>
      </div>
    </div>`;
  });

  document.getElementById("courses").innerHTML=html;
}

function toggleForecast(btn){
  const card=btn.closest(".card");
  const days=card.querySelectorAll(".extra-day");

  const expanded=btn.innerText==="æ”¶åˆ";

  days.forEach((d,i)=>{
    if(i>=2) d.style.display=expanded?"none":"block";
  });

  btn.innerText=expanded?"å±•é–‹":"æ”¶åˆ";
}

/* ========= å•Ÿå‹• ========= */

buildModelButtons();
buildRegionButtons();
loadCourses();

</script>
</body>
</html>
