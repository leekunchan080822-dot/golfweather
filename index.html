<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¨å°é«˜çˆ¾å¤«çƒå ´é›™æ¨¡å‹å¤©æ°£ç³»çµ± 2026 PRO</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f9;margin:0;padding:15px;}
h2{text-align:center;margin-bottom:10px;}
button{margin:4px;padding:6px 14px;border-radius:20px;border:1px solid #ccc;background:white;cursor:pointer;font-size:13px;}
button.active{background:#111;color:white;border-color:#111;}
.card{background:white;border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.day-block{font-size:13px;margin-top:8px;padding-top:8px;border-top:1px solid #eee;line-height:1.6;}
.rain-high{color:#e11d48;font-weight:bold;}
.wind-high{color:#d97706;font-weight:bold;}
.gust-high{color:#b91c1c;font-weight:bold;}
.map-link{font-size:12px;color:#2563eb;text-decoration:none;margin-left:6px;}
.map-link:hover{text-decoration:underline;}
.loading{text-align:center;padding:30px;color:#666;}
</style>
</head>

<body>

<h2>å…¨å°é«˜çˆ¾å¤«çƒå ´é›™æ¨¡å‹å¤©æ°£ç³»çµ± PRO</h2>

<div id="modelButtons"></div>
<div id="regionButtons"></div>
<div id="courses" class="loading">è«‹é¸æ“‡å€åŸŸ</div>

<script>

/* ======================= åŸºæœ¬è¨­å®š ======================= */

const CWA_KEY = "CWA-60E4630E-A677-453A-BD76-C74F148C86ED";
let currentModel = "ECMWF";
let lastRegion = null;
let weatherCache = {};
let cwaRawCache = null;

/* ======================= å·¥å…·å‡½å¼ ======================= */

function getWeekday(dateStr){
  const d=new Date(dateStr);
  return ["é€±æ—¥","é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­"][d.getDay()];
}

function kmh(ms){
  return ms==null ? null : Math.round(ms*3.6);
}

function avg(arr){
  if(!arr || !arr.length) return null;
  return arr.reduce((a,b)=>a+b,0)/arr.length;
}

/* ======================= çƒå ´è³‡æ–™ ======================= */
/* âš ï¸ ä½ åŸæœ¬çš„å®Œæ•´ courses é™£åˆ—ç›´æ¥è²¼åœ¨é€™è£¡å³å¯ */
/* æˆ‘æ­¤è™•ç•¥ç¸®ï¼Œè«‹ä¿ç•™ä½ å®Œæ•´é‚£ä»½ */

const courses = [

/* å°åŒ— / æ–°åŒ— */
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"ç¿¡ç¿ é«˜çˆ¾å¤«çƒå ´", lat:25.18731, lon:121.68352 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"é»ƒé‡‘æµ·å²¸é«˜çˆ¾å¤«çƒå ´", lat:25.29174, lon:121.57942 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"æ¿±æµ·é«˜çˆ¾å¤«ä¿±æ¨‚éƒ¨", lat:25.28115, lon:121.54718 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"å°ç£ï¼ˆè€æ·¡æ°´ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:25.17952, lon:121.42965 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"å¤§å±¯é«˜çˆ¾å¤«çƒå ´", lat:25.18642, lon:121.46333 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"æ®çš‡ï¼ˆæ–°æ·¡æ°´ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:25.19562, lon:121.46115 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"æ—å£é«˜çˆ¾å¤«çƒå ´", lat:25.09312, lon:121.34108 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"å…«é‡Œåœ‹éš›é«˜çˆ¾å¤«çƒå ´", lat:25.10972, lon:121.36532 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"ç¾éº—è¯é«˜çˆ¾å¤«çƒå ´", lat:25.10173, lon:121.37313 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"å¹¸ç¦é«˜çˆ¾å¤«çƒå ´", lat:25.11143, lon:121.34419 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"æ±è¯é«˜çˆ¾å¤«çƒå ´", lat:25.11938, lon:121.32532 },

/* æ¡ƒåœ’ */
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"å°åŒ—é«˜çˆ¾å¤«çƒå ´", lat:25.07195, lon:121.32168 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"çµ±å¸¥é«˜çˆ¾å¤«çƒå ´", lat:25.05142, lon:121.32442 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"é•·åºšé«˜çˆ¾å¤«çƒå ´", lat:25.05033, lon:121.37891 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"æ±æ–¹é«˜çˆ¾å¤«çƒå ´", lat:25.05668, lon:121.34862 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"ç¬¬ä¸€é«˜çˆ¾å¤«çƒå ´", lat:25.07417, lon:121.28056 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"æ°¸æ¼¢é«˜çˆ¾å¤«çƒå ´", lat:25.09918, lon:121.28251 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"æ¡ƒåœ’é«˜çˆ¾å¤«çƒå ´", lat:24.89833, lon:121.21806 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"å¤§æºªé«˜çˆ¾å¤«çƒå ´", lat:24.84362, lon:121.28111 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"é¾æ½­é«˜çˆ¾å¤«çƒå ´", lat:24.83889, lon:121.21639 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"æšæ˜‡é«˜çˆ¾å¤«é„‰æ‘ä¿±æ¨‚éƒ¨", lat:24.87222, lon:121.14445 },

/* å®œè˜­ / èŠ±è“® */
{ region:"èŠ±æ±", city:"å®œè˜­ç¸£", name:"ç¤æºªé«˜çˆ¾å¤«çƒå ´", lat:24.83222, lon:121.75833 },
{ region:"èŠ±æ±", city:"èŠ±è“®ç¸£", name:"èŠ±è“®é«˜çˆ¾å¤«çƒå ´", lat:23.99862, lon:121.63112 },

/* æ–°ç«¹ / è‹—æ — */
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"å†èˆˆé«˜çˆ¾å¤«çƒå ´", lat:24.88723, lon:121.03751 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"æ–°ç«¹ï¼ˆæ–°è±ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:24.89752, lon:120.97889 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"è‹—æ —ç¸£", name:"æ±æ–¹ä¹‹æ˜Ÿé«˜çˆ¾å¤«çƒå ´", lat:24.71168, lon:121.05056 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"ç«‹ç›Šé«˜çˆ¾å¤«çƒå ´", lat:24.78667, lon:121.20639 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"æ—­é™½é«˜çˆ¾å¤«çƒå ´", lat:24.78112, lon:121.22694 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"è€çˆºé—œè¥¿é«˜çˆ¾å¤«çƒå ´", lat:24.78056, lon:121.18944 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"å±±æºªåœ°é«˜çˆ¾å¤«çƒå ´", lat:24.79333, lon:121.19222 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"å¯¶å±±é«˜çˆ¾å¤«çƒå ´", lat:24.73972, lon:121.02639 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"è‹—æ —ç¸£", name:"çš‡å®¶é«˜çˆ¾å¤«çƒå ´", lat:24.58278, lon:120.89306 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"è‹—æ —ç¸£", name:"å…¨åœ‹é«˜çˆ¾å¤«çƒå ´", lat:24.39473, lon:120.76056 },

/* å°ä¸­ / å½°åŒ– / å—æŠ• */
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", city:"è‡ºä¸­å¸‚", name:"æ¸…æ³‰å´—é«˜çˆ¾å¤«çƒå ´", lat:24.25472, lon:120.61862 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", city:"è‡ºä¸­å¸‚", name:"è±åŸé«˜çˆ¾å¤«çƒå ´", lat:24.24833, lon:120.75112 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", city:"è‡ºä¸­å¸‚", name:"å°ä¸­åœ‹éš›é«˜çˆ¾å¤«çƒå ´", lat:24.18445, lon:120.75222 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", city:"è‡ºä¸­å¸‚", name:"éœ§å³°é«˜çˆ¾å¤«çƒå ´", lat:24.03528, lon:120.73028 },

/* å˜‰ç¾© / å°å— / é«˜é›„ / å±æ± */
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"å˜‰ç¾©ç¸£", name:"æ£•æ¢ æ¹–é«˜çˆ¾å¤«çƒå ´", lat:23.44752, lon:120.52833 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"è‡ºå—å¸‚", name:"æ–‘èŠèŠ±é«˜çˆ¾å¤«ä¿±æ¨‚éƒ¨", lat:23.23806, lon:120.47889 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"å˜‰ç¾©ç¸£", name:"å˜‰å…‰é«˜çˆ¾å¤«çƒå ´", lat:23.47389, lon:120.47251 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"è‡ºå—å¸‚", name:"å°å—é«˜çˆ¾å¤«çƒå ´ï¼ˆæ–°åŒ–ï¼‰", lat:23.01889, lon:120.35807 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"è‡ºå—å¸‚", name:"å—ä¸€é«˜çˆ¾å¤«çƒå ´", lat:22.95528, lon:120.32112 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"è‡ºå—å¸‚", name:"å—å¯¶é«˜çˆ¾å¤«çƒå ´", lat:23.20167, lon:120.41306 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"é«˜é›„å¸‚", name:"å¤§å´—å±±é«˜çˆ¾å¤«çƒå ´", lat:22.84694, lon:120.38028 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"é«˜é›„å¸‚", name:"ä¿¡èª¼é«˜çˆ¾å¤«çƒå ´", lat:22.72140, lon:120.43556 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"é«˜é›„å¸‚", name:"è§€éŸ³å±±é«˜çˆ¾å¤«çƒå ´", lat:22.73028, lon:120.38111 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"å±æ±ç¸£", name:"å±æ±é«˜çˆ¾å¤«çƒå ´", lat:22.68057, lon:120.50528 }

];

/* ======================= å€åŸŸæ•´ç† ======================= */

const regions = [...new Set(courses.map(c=>c.region))];

function buildRegionButtons(){
  const container=document.getElementById("regionButtons");
  container.innerHTML="";
  regions.forEach(r=>{
    const btn=document.createElement("button");
    btn.innerText=r;
    btn.onclick=()=>loadRegion(r);
    container.appendChild(btn);
  });
}

/* ======================= ECMWF ======================= */

async function fetchECMWF(course){
  const cacheKey = `${course.name}_ECMWF`;
  if(weatherCache[cacheKey]) return weatherCache[cacheKey];

  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${course.lat}&longitude=${course.lon}&hourly=temperature_2m,precipitation_probability,precipitation,wind_speed_10m,wind_gusts_10m&forecast_days=5&timezone=Asia%2FTaipei`;
    const res=await fetch(url);
    const data=await res.json();
    const parsed=parseECMWF(data);
    weatherCache[cacheKey]=parsed;
    return parsed;
  }catch(e){
    console.error("ECMWFéŒ¯èª¤",e);
    return [];
  }
}

function parseECMWF(data){
  if(!data?.hourly?.time) return [];

  const { time,temperature_2m,precipitation_probability,precipitation,wind_speed_10m,wind_gusts_10m } = data.hourly;
  let days={};

  for(let i=0;i<time.length;i++){
    const [date,t]=time[i].split("T");
    const hour=parseInt(t.split(":")[0]);  // âœ… ä¿®æ­£

    if(hour<8||hour>=18) continue;

    if(!days[date]) days[date]={am:{t:[],p:[],r:[],w:[],g:[]},pm:{t:[],p:[],r:[],w:[],g:[]}};

    const bucket=hour<12?"am":"pm";

    days[date][bucket].t.push(temperature_2m[i]);
    days[date][bucket].p.push(precipitation_probability?.[i]||0);
    days[date][bucket].r.push(precipitation?.[i]||0);
    days[date][bucket].w.push(wind_speed_10m?.[i]||0);
    days[date][bucket].g.push(wind_gusts_10m?.[i]||0);
  }

  return Object.entries(days).map(([date,val])=>({
    date,
    am:buildBlock(val.am),
    pm:buildBlock(val.pm)
  })).slice(0,5);
}

function buildBlock(bucket){
  return {
    temp:bucket.t.length?Math.round(avg(bucket.t)):null,
    rainProb:bucket.p.length?Math.round(avg(bucket.p)):null,
    rainMM:bucket.r.length?avg(bucket.r).toFixed(1):null,
    wind:bucket.w.length?kmh(avg(bucket.w)):null,
    gust:bucket.g.length?kmh(avg(bucket.g)):null
  };
}

/* ======================= CWA ======================= */

async function fetchCWA(course){

  try{
    if(!cwaRawCache){
      const url=`https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${CWA_KEY}&format=JSON`;
      const res=await fetch(url);
      cwaRawCache=await res.json();
    }

    if(!cwaRawCache?.records?.location) return [];

    const loc=cwaRawCache.records.location.find(l=>l.locationName===course.city);
    if(!loc) return [];

    // âœ… é˜²å‘†å¯«æ³•
    const wxObj = loc.weatherElement.find(e=>e.elementName==="Wx");
    const popObj = loc.weatherElement.find(e=>e.elementName==="PoP");
    const minTObj = loc.weatherElement.find(e=>e.elementName==="MinT");
    const maxTObj = loc.weatherElement.find(e=>e.elementName==="MaxT");

    if(!wxObj || !popObj || !minTObj || !maxTObj) return [];

    const wx = wxObj.time;
    const pop = popObj.time;
    const minT = minTObj.time;
    const maxT = maxTObj.time;

    const length=Math.min(wx.length,pop.length,minT.length,maxT.length);

    let result=[];
    for(let i=0;i<length;i++){
      const date=wx[i].startTime.split(" ")[0];
      const tempAvg=Math.round(
        (parseInt(minT[i].parameter.parameterName)+
         parseInt(maxT[i].parameter.parameterName))/2
      );

      result.push({
        date,
        am:{temp:tempAvg,rainProb:parseInt(pop[i].parameter.parameterName),rainMM:null,wind:null,gust:null},
        pm:{temp:tempAvg,rainProb:parseInt(pop[i].parameter.parameterName),rainMM:null,wind:null,gust:null}
      });
    }

    return result.slice(0,5);

  }catch(e){
    console.error("CWAéŒ¯èª¤",e);
    return [];
  }
}

/* ======================= UI ======================= */

async function loadRegion(region){

  lastRegion=region;
  document.getElementById("courses").innerHTML="<div class='loading'>è¼‰å…¥ä¸­...</div>";

  const list=courses.filter(c=>c.region===region);

  const forecasts=await Promise.all(
    list.map(course=> currentModel==="ECMWF"?fetchECMWF(course):fetchCWA(course))
  );

  let html="";
  list.forEach((course,i)=>{
    html+=buildCard(course,forecasts[i]);
  });

  document.getElementById("courses").innerHTML=html;
}

function buildCard(course,forecast){

  let daysHTML="";

  if(forecast && forecast.length){
    forecast.forEach(day=>{
      daysHTML+=`
      <div class="day-block">
        <b>${day.date} (${getWeekday(day.date)})</b><br>
        ğŸŒ… 08â€“12ï¼š${renderBlock(day.am)}<br>
        ğŸŒ‡ 12â€“18ï¼š${renderBlock(day.pm)}
      </div>`;
    });
  }else{
    daysHTML=`<div class="day-block">æš«ç„¡è³‡æ–™</div>`;
  }

  return`
  <div class="card">
    <b>${course.name}</b>
    <a class="map-link" href="https://www.google.com/maps?q=${course.lat},${course.lon}" target="_blank">ğŸ“ åœ°åœ–</a>
    <a class="map-link" href="https://www.google.com/maps/dir/?api=1&destination=${course.lat},${course.lon}" target="_blank">ğŸš— å°èˆª</a>
    ${daysHTML}
  </div>`;
}

function renderBlock(block){
  if(!block) return "â€”";

  const rainClass=(block.rainProb!=null && block.rainProb>=50)?"rain-high":"";
  const windClass=(block.wind!=null && block.wind>=30)?"wind-high":"";
  const gustClass=(block.gust!=null && block.gust>=50)?"gust-high":"";

  return`
    ğŸŒ¡ ${block.temp??"â€”"}Â°C
    â˜” <span class="${rainClass}">${block.rainProb??"â€”"}%</span>
    ğŸŒ§ ${block.rainMM??"â€”"}mm
    ğŸŒ¬ <span class="${windClass}">${block.wind??"â€”"}</span>km/h
    ğŸ’¨ <span class="${gustClass}">${block.gust??"â€”"}</span>km/h
  `;
}

/* ======================= æ¨¡å‹æŒ‰éˆ• ======================= */

function buildModelButtons(){
  const container=document.getElementById("modelButtons");
  container.innerHTML="";
  ["ECMWF","CWA"].forEach(model=>{
    const btn=document.createElement("button");
    btn.innerText=model;
    btn.className=model===currentModel?"active":"";
    btn.onclick=()=>{
      currentModel=model;
      buildModelButtons();
      if(lastRegion) loadRegion(lastRegion);
    };
    container.appendChild(btn);
  });
}

/* ======================= å•Ÿå‹• ======================= */

buildModelButtons();
buildRegionButtons();

</script>
</body>
</html>
