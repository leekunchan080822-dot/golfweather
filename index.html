<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>711｜全台高爾夫球場精準天氣預報（ECMWF）+導航</title>

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f5f7fa;margin:0;padding:15px;}
.header-info{text-align:center;font-size:14px;color:#555;}
h2{text-align:center;margin:10px 0;}
.region-buttons{text-align:center;margin:15px 0;}
.region-buttons button{margin:4px;padding:6px 12px;border-radius:20px;border:1px solid #ccc;background:white;cursor:pointer;font-size:13px;}
.region-buttons button.active{background:#111;color:white;border-color:#111;}
.region-title{font-size:18px;font-weight:bold;margin:25px 0 10px;}
.card{background:white;border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 3px 10px rgba(0,0,0,0.08);}
.day-block{font-size:13px;margin-top:6px;padding-top:6px;border-top:1px solid #eee;}
.rain-high{color:red;font-weight:bold;}
.wind-high{color:#d97706;font-weight:bold;}
.gust-high{color:#b91c1c;font-weight:bold;}
.error{color:red;}
.toggle-btn{font-size:12px;padding:4px 8px;border-radius:6px;border:1px solid #ccc;background:#f8f8f8;cursor:pointer;}
.nav-btn{
    font-size:12px;
    padding:3px 8px;
    border-radius:6px;
    border:1px solid #2563eb;
    background:#2563eb;
    color:white;
    cursor:pointer;
    margin-left:8px;
}
.nav-btn:hover{background:#1e40af;}
small{color:#777;}
</style>
</head>

<body>

<div class="header-info" id="dateInfo"></div>
<div class="header-info">資料來源：Open-Meteo ECMWF 模型｜逐小時格點預報</div>
<h2>711 專業版 V2｜全台高爾夫球場 7 日精準預報（風速＋雨量強化版+導航）</h2>

<div class="region-buttons" id="regionButtons"></div>
<div id="courses">載入中...</div>

<script>

/* ===== 日期 ===== */
const today=new Date();
document.getElementById("dateInfo").innerText=
"資料更新時間："+today.toLocaleString();

/* ===== 星期 ===== */
function getWeekday(dateStr){
    const d=new Date(dateStr);
    const arr=["週日","週一","週二","週三","週四","週五","週六"];
    return arr[d.getDay()];
}

/* ===== Google 導航 ===== */
function openNavigation(lat,lon,name){
    const url=`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;
    window.open(url,"_blank");
}

/* ===== 全台球場清單（略，保持你原本內容） ===== */
const courses=[
/* 台北 / 新北 */
{ region:"台北市 / 新北市", city:"新北市", name:"翡翠高爾夫球場", lat:25.18733, lon:121.68351 },
{ region:"台北市 / 新北市", city:"新北市", name:"黃金海岸高爾夫球場", lat:25.29175, lon:121.57945 },
{ region:"台北市 / 新北市", city:"新北市", name:"濱海高爾夫俱樂部", lat:25.28114, lon:121.54716 },
{ region:"台北市 / 新北市", city:"新北市", name:"台灣（老淡水）高爾夫球場", lat:25.17646, lon:121.43094 },
{ region:"台北市 / 新北市", city:"新北市", name:"大屯高爾夫球場", lat:25.18641, lon:121.46332 },
{ region:"台北市 / 新北市", city:"新北市", name:"揮皇（新淡水）高爾夫球場", lat:25.19561, lon:121.46114 },
{ region:"台北市 / 新北市", city:"新北市", name:"林口高爾夫球場", lat:25.09311, lon:121.34107 },
{ region:"台北市 / 新北市", city:"新北市", name:"八里國際高爾夫球場", lat:25.10971, lon:121.36531 },
{ region:"台北市 / 新北市", city:"新北市", name:"美麗華高爾夫球場", lat:25.10174, lon:121.37314 },
{ region:"台北市 / 新北市", city:"新北市", name:"幸福高爾夫球場", lat:25.11142, lon:121.34418 },
{ region:"台北市 / 新北市", city:"新北市", name:"東華高爾夫球場", lat:25.11937, lon:121.32531 },

/* 桃園 */
{ region:"桃園", city:"桃園市", name:"台北高爾夫球場", lat:25.06045, lon:121.32608 },
{ region:"桃園", city:"桃園市", name:"統帥高爾夫球場", lat:25.05141, lon:121.32441 },
{ region:"桃園", city:"桃園市", name:"長庚高爾夫球場", lat:25.05032, lon:121.37892 },
{ region:"桃園", city:"桃園市", name:"東方高爾夫球場", lat:25.05667, lon:121.34861 },
{ region:"桃園", city:"桃園市", name:"第一高爾夫球場", lat:25.07416, lon:121.28055 },
{ region:"桃園", city:"桃園市", name:"永漢高爾夫球場", lat:25.09917, lon:121.28252 },
{ region:"桃園", city:"桃園市", name:"桃園高爾夫球場", lat:24.89832, lon:121.21805 },
{ region:"桃園", city:"桃園市", name:"大溪高爾夫球場", lat:24.84361, lon:121.28112 },
{ region:"桃園", city:"桃園市", name:"龍潭高爾夫球場", lat:24.83888, lon:121.21638 },
{ region:"桃園", city:"桃園市", name:"揚昇高爾夫鄉村俱樂部", lat:24.87221, lon:121.14446 },

/* 宜蘭 / 花蓮 */
{ region:"花東", city:"宜蘭縣", name:"礁溪高爾夫球場", lat:24.81622, lon:121.72211 },
{ region:"花東", city:"花蓮縣", name:"花蓮高爾夫球場", lat:23.99861, lon:121.63113 },

/* 新竹 / 苗栗 */
{ region:"新竹 / 苗栗", city:"新竹縣", name:"再興高爾夫球場", lat:24.88722, lon:121.03752 },
{ region:"新竹 / 苗栗", city:"新竹縣", name:"新竹（新豐）高爾夫球場", lat:24.89751, lon:120.97888 },
{ region:"新竹 / 苗栗", city:"苗栗縣", name:"東方之星高爾夫球場", lat:24.71167, lon:121.05055 },
{ region:"新竹 / 苗栗", city:"新竹縣", name:"立益高爾夫球場", lat:24.78667, lon:121.20639 },
{ region:"新竹 / 苗栗", city:"新竹縣", name:"旭陽高爾夫球場", lat:24.78112, lon:121.22694 },
{ region:"新竹 / 苗栗", city:"新竹縣", name:"老爺關西高爾夫球場", lat:24.78056, lon:121.18944 },
{ region:"新竹 / 苗栗", city:"新竹縣", name:"山溪地高爾夫球場", lat:24.79333, lon:121.19222 },
{ region:"新竹 / 苗栗", city:"新竹縣", name:"寶山高爾夫球場", lat:24.73972, lon:121.02639 },
{ region:"新竹 / 苗栗", city:"苗栗縣", name:"皇家高爾夫球場", lat:24.58278, lon:120.89306 },
{ region:"新竹 / 苗栗", city:"苗栗縣", name:"全國高爾夫球場", lat:24.39472, lon:120.76055 },

/* 台中 / 彰化 / 南投 */
{ region:"台中 / 彰化 / 南投", city:"臺中市", name:"清泉崗高爾夫球場", lat:24.25472, lon:120.61862 },
{ region:"台中 / 彰化 / 南投", city:"臺中市", name:"豐原高爾夫球場", lat:24.24833, lon:120.75112 },
{ region:"台中 / 彰化 / 南投", city:"臺中市", name:"台中國際高爾夫球場", lat:24.18445, lon:120.75222 },
{ region:"台中 / 彰化 / 南投", city:"臺中市", name:"霧峰高爾夫球場", lat:24.03528, lon:120.73028 },

/* 嘉義 / 台南 / 高雄 / 屏東 */
{ region:"嘉義 / 台南 / 高雄 / 屏東", city:"嘉義縣", name:"棕梠湖高爾夫球場", lat:23.44751, lon:120.52834 },
{ region:"嘉義 / 台南 / 高雄 / 屏東", city:"臺南市", name:"斑芝花高爾夫俱樂部", lat:23.23806, lon:120.47889 },
{ region:"嘉義 / 台南 / 高雄 / 屏東", city:"嘉義縣", name:"嘉光高爾夫球場", lat:23.47389, lon:120.47251 },
{ region:"嘉義 / 台南 / 高雄 / 屏東", city:"臺南市", name:"台南高爾夫球場（新化）", lat:23.01888, lon:120.35806 },
{ region:"嘉義 / 台南 / 高雄 / 屏東", city:"臺南市", name:"南一高爾夫球場", lat:22.95528, lon:120.32112 },
{ region:"嘉義 / 台南 / 高雄 / 屏東", city:"臺南市", name:"南寶高爾夫球場", lat:23.20167, lon:120.41306 },
{ region:"嘉義 / 台南 / 高雄 / 屏東", city:"高雄市", name:"大崗山高爾夫球場", lat:22.84694, lon:120.38028 },
{ region:"嘉義 / 台南 / 高雄 / 屏東", city:"高雄市", name:"信誼高爾夫球場", lat:22.72140, lon:120.43556 },
{ region:"嘉義 / 台南 / 高雄 / 屏東", city:"高雄市", name:"觀音山高爾夫球場", lat:22.73028, lon:120.38111 },
{ region:"嘉義 / 台南 / 高雄 / 屏東", city:"屏東縣", name:"屏東高爾夫球場", lat:22.68056, lon:120.50527 }

];

/* ===== ECMWF API ===== */
async function getWeeklyWeather(lat,lon){

    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation_probability,precipitation,windspeed_10m,windgusts_10m&daily=temperature_2m_max,temperature_2m_min&forecast_days=7&timezone=Asia/Taipei`;

    try{
        const res=await fetch(url);
        const data=await res.json();

        const hourly=data.hourly;
        const daily=data.daily;

        const results=[];

        for(let d=0;d<7;d++){

            const date=daily.time[d];
            const morning=[];
            const afternoon=[];

            hourly.time.forEach((t,i)=>{
                if(t.startsWith(date)){
                    const h=parseInt(t.substring(11,13));
                    if(h>=8&&h<12) morning.push(i);
                    if(h>=12&&h<18) afternoon.push(i);
                }
            });

            const avg=(arr,key)=>
                arr.length?Math.round(arr.reduce((s,i)=>s+hourly[key][i],0)/arr.length):0;

            results.push({
                date,
                weekday:getWeekday(date),
                minT:daily.temperature_2m_min[d],
                maxT:daily.temperature_2m_max[d],
                popMorning:avg(morning,"precipitation_probability"),
                popAfternoon:avg(afternoon,"precipitation_probability"),
                rainMorning:avg(morning,"precipitation"),
                rainAfternoon:avg(afternoon,"precipitation"),
                windMorning:avg(morning,"windspeed_10m"),
                windAfternoon:avg(afternoon,"windspeed_10m"),
                gustMorning:avg(morning,"windgusts_10m"),
                gustAfternoon:avg(afternoon,"windgusts_10m")
            });
        }

        return {forecasts:results};

    }catch(e){
        console.log(e);
        return {error:true};
    }
}

/* ===== UI 控制 ===== */
let weatherCache={};

function createRegionButtons(){
    const regions=["全部",...new Set(courses.map(c=>c.region))];
    const container=document.getElementById("regionButtons");
    container.innerHTML="";
    regions.forEach(r=>{
        const btn=document.createElement("button");
        btn.innerText=r;
        btn.onclick=()=>filterRegion(r);
        container.appendChild(btn);
    });
    container.firstChild.classList.add("active");
}

function filterRegion(selected){
    document.querySelectorAll(".region-buttons button").forEach(btn=>{
        btn.classList.toggle("active",btn.innerText===selected);
    });
    renderCourses(selected);
}

async function loadCourses(){
    await Promise.all(
        courses.map(async c=>{
            weatherCache[c.name]=await getWeeklyWeather(c.lat,c.lon);
        })
    );
    createRegionButtons();
    renderCourses("全部");
}

/* ===== 渲染 ===== */
function renderCourses(filter="全部"){

    let html="";
    const filtered=filter==="全部"?courses:courses.filter(c=>c.region===filter);

    const grouped=filtered.reduce((acc,c)=>{
        if(!acc[c.region]) acc[c.region]=[];
        acc[c.region].push(c);
        return acc;
    },{});

    for(const region in grouped){

        html+=`<div class="region-title">${region}</div>`;

        grouped[region].forEach((course,index)=>{

            const w=weatherCache[course.name];

            if(!w||w.error){
                html+=`<div class="card"><strong>${course.name}</strong><div class="error">讀取失敗</div></div>`;
                return;
            }

            const cardId=`card_${region}_${index}`.replace(/\s/g,'');

            let forecastHTML="";

            w.forecasts.forEach((f,i)=>{

                const hidden=i>=2?"display:none;":"";

                forecastHTML+=`
                <div class="day-block extra-day" style="${hidden}">
                <strong>${f.date}（${f.weekday}）</strong><br>
                溫度 ${f.minT}°C - ${f.maxT}°C
                </div>`;
            });

            forecastHTML+=`
            <div style="text-align:right;margin-top:6px;">
                <button class="toggle-btn" onclick="toggleForecast('${cardId}',this)">展開</button>
            </div>`;

            html+=`
            <div class="card" id="${cardId}">
                <strong>${course.name}</strong>
                <button class="nav-btn" onclick="openNavigation(${course.lat},${course.lon},'${course.name}')">導航</button><br>
                <small>座標：${course.lat}, ${course.lon}</small>
                ${forecastHTML}
            </div>`;
        });
    }

    document.getElementById("courses").innerHTML=html;
}

/* ===== 展開收合 ===== */
function toggleForecast(cardId,btn){
    const card=document.getElementById(cardId);
    const extra=card.querySelectorAll(".extra-day");
    const hidden=extra[2]?.style.display==="none";
    extra.forEach((d,i)=>{
        if(i>=2) d.style.display=hidden?"block":"none";
    });
    btn.innerText=hidden?"收合":"展開";
}

loadCourses();

</script>
</body>
</html>
