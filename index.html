<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¨å°é«˜çˆ¾å¤«çƒå ´å¤©æ°£é å ± 2026 PRO</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f5f7fa;margin:0;padding:15px;}
h2{text-align:center;margin:10px 0;}
.header{text-align:center;font-size:13px;color:#666;margin-bottom:8px;}
button{margin:4px;padding:6px 12px;border-radius:20px;border:1px solid #ccc;background:white;cursor:pointer;font-size:13px;}
button.active{background:#111;color:white;border-color:#111;}
.card{background:white;border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 3px 10px rgba(0,0,0,0.08);}
.region-title{font-size:18px;font-weight:bold;margin:25px 0 10px;}
.day-block{font-size:14px;margin-top:8px;padding-top:8px;border-top:1px solid #eee;line-height:1.7;}
.rain-high{color:#e11d48;font-weight:bold;}
.wind-high{color:#d97706;font-weight:bold;}
.gust-high{color:#b91c1c;font-weight:bold;}
.toggle-btn{font-size:12px;padding:4px 8px;border-radius:6px;border:1px solid #ccc;background:#f8f8f8;cursor:pointer;}
.map-link{font-size:12px;color:#2563eb;text-decoration:none;margin-left:6px;}
.loading{text-align:center;padding:30px;color:#666;}
</style>
</head>

<body>

<div class="header" id="updateTime"></div>
<h2>å…¨å°é«˜çˆ¾å¤«çƒå ´ç²¾æº–å¤©æ°£é å ± 2026 PRO</h2>

<div id="modelButtons" style="text-align:center;"></div>
<div id="regionButtons" style="text-align:center;"></div>
<div id="courses" class="loading">è«‹é¸æ“‡å€åŸŸ</div>

<script>

/* ================= åŸºæœ¬è¨­å®š ================= */

const CWA_KEY="CWA-60E4630E-A677-453A-BD76-C74F148C86ED";
let currentModel="ECMWF";
let lastRegion=null;
let cache={};
let cwaRaw=null;

document.getElementById("updateTime").innerText=
"è³‡æ–™æ›´æ–°æ™‚é–“ï¼š"+new Date().toLocaleString();

/* ================= å·¥å…· ================= */

function getWeekday(d){
  return ["é€±æ—¥","é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­"][new Date(d).getDay()];
}
function avg(a){return a.length? a.reduce((s,v)=>s+v,0)/a.length : 0;}
function kmh(ms){return Math.round(ms*3.6);}

/* ================= çƒå ´è³‡æ–™ ================= */
/* ğŸ‘‰ ä½¿ç”¨ä½ å®Œæ•´æ¸…å–®å³å¯ */

const courses=[
/* å°åŒ— / æ–°åŒ— */
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"ç¿¡ç¿ é«˜çˆ¾å¤«çƒå ´", lat:25.18733, lon:121.68351 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"é»ƒé‡‘æµ·å²¸é«˜çˆ¾å¤«çƒå ´", lat:25.29175, lon:121.57945 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"æ¿±æµ·é«˜çˆ¾å¤«ä¿±æ¨‚éƒ¨", lat:25.28114, lon:121.54716 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"å°ç£ï¼ˆè€æ·¡æ°´ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:25.17646, lon:121.43094 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"å¤§å±¯é«˜çˆ¾å¤«çƒå ´", lat:25.18641, lon:121.46332 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"æ®çš‡ï¼ˆæ–°æ·¡æ°´ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:25.19561, lon:121.46114 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"æ—å£é«˜çˆ¾å¤«çƒå ´", lat:25.09311, lon:121.34107 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"å…«é‡Œåœ‹éš›é«˜çˆ¾å¤«çƒå ´", lat:25.10971, lon:121.36531 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"ç¾éº—è¯é«˜çˆ¾å¤«çƒå ´", lat:25.10174, lon:121.37314 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"å¹¸ç¦é«˜çˆ¾å¤«çƒå ´", lat:25.11142, lon:121.34418 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", city:"æ–°åŒ—å¸‚", name:"æ±è¯é«˜çˆ¾å¤«çƒå ´", lat:25.11937, lon:121.32531 },

/* æ¡ƒåœ’ */
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"å°åŒ—é«˜çˆ¾å¤«çƒå ´", lat:25.06045, lon:121.32608 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"çµ±å¸¥é«˜çˆ¾å¤«çƒå ´", lat:25.05141, lon:121.32441 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"é•·åºšé«˜çˆ¾å¤«çƒå ´", lat:25.05032, lon:121.37892 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"æ±æ–¹é«˜çˆ¾å¤«çƒå ´", lat:25.05667, lon:121.34861 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"ç¬¬ä¸€é«˜çˆ¾å¤«çƒå ´", lat:25.07416, lon:121.28055 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"æ°¸æ¼¢é«˜çˆ¾å¤«çƒå ´", lat:25.09917, lon:121.28252 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"æ¡ƒåœ’é«˜çˆ¾å¤«çƒå ´", lat:24.89832, lon:121.21805 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"å¤§æºªé«˜çˆ¾å¤«çƒå ´", lat:24.84361, lon:121.28112 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"é¾æ½­é«˜çˆ¾å¤«çƒå ´", lat:24.83888, lon:121.21638 },
{ region:"æ¡ƒåœ’", city:"æ¡ƒåœ’å¸‚", name:"æšæ˜‡é«˜çˆ¾å¤«é„‰æ‘ä¿±æ¨‚éƒ¨", lat:24.87221, lon:121.14446 },

/* å®œè˜­ / èŠ±è“® */
{ region:"èŠ±æ±", city:"å®œè˜­ç¸£", name:"ç¤æºªé«˜çˆ¾å¤«çƒå ´", lat:24.81622, lon:121.72211 },
{ region:"èŠ±æ±", city:"èŠ±è“®ç¸£", name:"èŠ±è“®é«˜çˆ¾å¤«çƒå ´", lat:23.99861, lon:121.63113 },

/* æ–°ç«¹ / è‹—æ — */
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"å†èˆˆé«˜çˆ¾å¤«çƒå ´", lat:24.88722, lon:121.03752 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"æ–°ç«¹ï¼ˆæ–°è±ï¼‰é«˜çˆ¾å¤«çƒå ´", lat:24.89751, lon:120.97888 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"è‹—æ —ç¸£", name:"æ±æ–¹ä¹‹æ˜Ÿé«˜çˆ¾å¤«çƒå ´", lat:24.71167, lon:121.05055 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"ç«‹ç›Šé«˜çˆ¾å¤«çƒå ´", lat:24.78667, lon:121.20639 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"æ—­é™½é«˜çˆ¾å¤«çƒå ´", lat:24.78112, lon:121.22694 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"è€çˆºé—œè¥¿é«˜çˆ¾å¤«çƒå ´", lat:24.78056, lon:121.18944 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"å±±æºªåœ°é«˜çˆ¾å¤«çƒå ´", lat:24.79333, lon:121.19222 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"æ–°ç«¹ç¸£", name:"å¯¶å±±é«˜çˆ¾å¤«çƒå ´", lat:24.73972, lon:121.02639 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"è‹—æ —ç¸£", name:"çš‡å®¶é«˜çˆ¾å¤«çƒå ´", lat:24.58278, lon:120.89306 },
{ region:"æ–°ç«¹ / è‹—æ —", city:"è‹—æ —ç¸£", name:"å…¨åœ‹é«˜çˆ¾å¤«çƒå ´", lat:24.39472, lon:120.76055 },

/* å°ä¸­ / å½°åŒ– / å—æŠ• */
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", city:"è‡ºä¸­å¸‚", name:"æ¸…æ³‰å´—é«˜çˆ¾å¤«çƒå ´", lat:24.25472, lon:120.61862 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", city:"è‡ºä¸­å¸‚", name:"è±åŸé«˜çˆ¾å¤«çƒå ´", lat:24.24833, lon:120.75112 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", city:"è‡ºä¸­å¸‚", name:"å°ä¸­åœ‹éš›é«˜çˆ¾å¤«çƒå ´", lat:24.18445, lon:120.75222 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", city:"è‡ºä¸­å¸‚", name:"éœ§å³°é«˜çˆ¾å¤«çƒå ´", lat:24.03528, lon:120.73028 },

/* å˜‰ç¾© / å°å— / é«˜é›„ / å±æ± */
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"å˜‰ç¾©ç¸£", name:"æ£•æ¢ æ¹–é«˜çˆ¾å¤«çƒå ´", lat:23.44751, lon:120.52834 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"è‡ºå—å¸‚", name:"æ–‘èŠèŠ±é«˜çˆ¾å¤«ä¿±æ¨‚éƒ¨", lat:23.23806, lon:120.47889 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"å˜‰ç¾©ç¸£", name:"å˜‰å…‰é«˜çˆ¾å¤«çƒå ´", lat:23.47389, lon:120.47251 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"è‡ºå—å¸‚", name:"å°å—é«˜çˆ¾å¤«çƒå ´ï¼ˆæ–°åŒ–ï¼‰", lat:23.01888, lon:120.35806 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"è‡ºå—å¸‚", name:"å—ä¸€é«˜çˆ¾å¤«çƒå ´", lat:22.95528, lon:120.32112 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"è‡ºå—å¸‚", name:"å—å¯¶é«˜çˆ¾å¤«çƒå ´", lat:23.20167, lon:120.41306 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"é«˜é›„å¸‚", name:"å¤§å´—å±±é«˜çˆ¾å¤«çƒå ´", lat:22.84694, lon:120.38028 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"é«˜é›„å¸‚", name:"ä¿¡èª¼é«˜çˆ¾å¤«çƒå ´", lat:22.72140, lon:120.43556 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"é«˜é›„å¸‚", name:"è§€éŸ³å±±é«˜çˆ¾å¤«çƒå ´", lat:22.73028, lon:120.38111 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", city:"å±æ±ç¸£", name:"å±æ±é«˜çˆ¾å¤«çƒå ´", lat:22.68056, lon:120.50527 }

];

/* ================= å€åŸŸæŒ‰éˆ• ================= */

const regions=[...new Set(courses.map(c=>c.region))];

function buildRegionButtons(){
  const container=document.getElementById("regionButtons");
  container.innerHTML="";
  regions.forEach(r=>{
    const btn=document.createElement("button");
    btn.innerText=r;
    btn.onclick=()=>loadRegion(r);
    container.appendChild(btn);
  });
}

/* ================= ECMWF ================= */

async function fetchECMWF(c){
  const key=c.name+"_e";
  if(cache[key]) return cache[key];

  const url=`https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lon}&hourly=temperature_2m,precipitation_probability,precipitation,wind_speed_10m,wind_gusts_10m&daily=temperature_2m_min,temperature_2m_max&forecast_days=7&timezone=Asia%2FTaipei`;

  try{
    const res=await fetch(url);
    const data=await res.json();
    const result=parseECMWF(data);
    cache[key]=result;
    return result;
  }catch{
    return [];
  }
}

function parseECMWF(data){
  if(!data?.hourly) return [];

  const {hourly,daily}=data;
  const results=[];

  for(let d=0; d<daily.time.length; d++){
    const date=daily.time[d];
    const am=[], pm=[];

    hourly.time.forEach((t,i)=>{
      if(t.startsWith(date)){
        const h=parseInt(t.substring(11,13));
        if(h>=8&&h<12) am.push(i);
        if(h>=12&&h<18) pm.push(i);
      }
    });

    results.push({
      date,
      minT:daily.temperature_2m_min[d],
      maxT:daily.temperature_2m_max[d],
      am:{
        pop:Math.round(avg(am.map(i=>hourly.precipitation_probability[i]||0))),
        rain:avg(am.map(i=>hourly.precipitation[i]||0)).toFixed(1),
        wind:kmh(avg(am.map(i=>hourly.wind_speed_10m[i]||0))),
        gust:kmh(avg(am.map(i=>hourly.wind_gusts_10m[i]||0)))
      },
      pm:{
        pop:Math.round(avg(pm.map(i=>hourly.precipitation_probability[i]||0))),
        rain:avg(pm.map(i=>hourly.precipitation[i]||0)).toFixed(1),
        wind:kmh(avg(pm.map(i=>hourly.wind_speed_10m[i]||0))),
        gust:kmh(avg(pm.map(i=>hourly.wind_gusts_10m[i]||0)))
      }
    });
  }

  return results;
}

/* ================= CWA ================= */

async function fetchCWA(c){
  if(!cwaRaw){
    const url=`https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${CWA_KEY}&format=JSON`;
    const res=await fetch(url);
    cwaRaw=await res.json();
  }

  const loc=cwaRaw.records.location.find(l=>l.locationName===c.city);
  if(!loc) return [];

  const minT=loc.weatherElement.find(e=>e.elementName==="MinT").time;
  const maxT=loc.weatherElement.find(e=>e.elementName==="MaxT").time;
  const pop=loc.weatherElement.find(e=>e.elementName==="PoP").time;

  return minT.map((_,i)=>({
    date:minT[i].startTime.split(" ")[0],
    minT:minT[i].parameter.parameterName,
    maxT:maxT[i].parameter.parameterName,
    am:{pop:parseInt(pop[i].parameter.parameterName),rain:"â€”",wind:"â€”",gust:"â€”"},
    pm:{pop:parseInt(pop[i].parameter.parameterName),rain:"â€”",wind:"â€”",gust:"â€”"}
  }));
}

/* ================= UI ================= */

async function loadRegion(region){
  lastRegion=region;
  document.getElementById("courses").innerHTML="<div class='loading'>è¼‰å…¥ä¸­...</div>";

  const list=courses.filter(c=>c.region===region);
  const forecasts=await Promise.all(
    list.map(c=>currentModel==="ECMWF"?fetchECMWF(c):fetchCWA(c))
  );

  let html="";
  html+=`<div class="region-title">${region}</div>`;

  list.forEach((c,i)=>{
    html+=buildCard(c,forecasts[i],i);
  });

  document.getElementById("courses").innerHTML=html;
}

function buildCard(c,forecast,index){

  if(!forecast||!forecast.length)
    return `<div class="card"><b>${c.name}</b><div class="day-block">æš«ç„¡è³‡æ–™</div></div>`;

  let content="";

  forecast.forEach((f,i)=>{
    const hidden=i>=2?"display:none;":"";
    const rainHigh=f.am.rain>=1?"rain-high":"";
    const windHigh=f.am.wind>=30?"wind-high":"";
    const gustHigh=f.am.gust>=45?"gust-high":"";

    content+=`
    <div class="day-block extra" style="${hidden}">
      <b>${f.date}ï¼ˆ${getWeekday(f.date)}ï¼‰</b><br>
      æº«åº¦ ${f.minT}Â°C - ${f.maxT}Â°C<br>
      08â€“12 â˜” <span class="${rainHigh}">${f.am.rain}mm (${f.am.pop}%)</span>
      ï½œğŸŒ¬ <span class="${windHigh}">${f.am.wind}km/h</span>
      ï½œğŸ’¨ <span class="${gustHigh}">${f.am.gust}</span><br>
      12â€“18 â˜” ${f.pm.rain}mm (${f.pm.pop}%)
      ï½œğŸŒ¬ ${f.pm.wind}km/h
      ï½œğŸ’¨ ${f.pm.gust}
    </div>`;
  });

  content+=`
  <div style="text-align:right;margin-top:6px;">
    <button class="toggle-btn" onclick="toggle(this)">å±•é–‹</button>
    <a class="map-link" target="_blank"
      href="https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lon}">å°èˆª</a>
  </div>`;

  return `<div class="card"><b>${c.name}</b>${content}</div>`;
}

function toggle(btn){
  const card=btn.closest(".card");
  const extra=card.querySelectorAll(".extra");
  const hidden=extra[2]?.style.display==="none";
  extra.forEach((d,i)=>{
    if(i>=2) d.style.display=hidden?"block":"none";
  });
  btn.innerText=hidden?"æ”¶åˆ":"å±•é–‹";
}

/* ================= æ¨¡å‹æŒ‰éˆ• ================= */

function buildModelButtons(){
  const container=document.getElementById("modelButtons");
  ["ECMWF","CWA"].forEach(m=>{
    const btn=document.createElement("button");
    btn.innerText=m;
    btn.className=m===currentModel?"active":"";
    btn.onclick=()=>{
      currentModel=m;
      buildModelButtons();
      if(lastRegion) loadRegion(lastRegion);
    };
    container.appendChild(btn);
  });
}

/* ================= å•Ÿå‹• ================= */

buildModelButtons();
buildRegionButtons();

</script>
</body>
</html>
