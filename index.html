<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>711 é›™æ¨¡å‹å°ˆæ¥­ç‰ˆï½œå…¨å°é«˜çˆ¾å¤«çƒå ´å¤©æ°£</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f5f7fa;margin:0;padding:15px;}
.header-info{text-align:center;font-size:14px;color:#555;}
h2{text-align:center;margin:10px 0;}
.model-buttons,.region-buttons{text-align:center;margin:15px 0;}
button{margin:4px;padding:6px 12px;border-radius:20px;border:1px solid #ccc;background:white;cursor:pointer;font-size:13px;}
button.active{background:#111;color:white;border-color:#111;}
.region-title{font-size:18px;font-weight:bold;margin:25px 0 10px;}
.card{background:white;border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 3px 10px rgba(0,0,0,0.08);}
.day-block{font-size:13px;margin-top:6px;padding-top:6px;border-top:1px solid #eee;}
.rain-high{color:red;font-weight:bold;}
.wind-high{color:#d97706;font-weight:bold;}
.gust-high{color:#b91c1c;font-weight:bold;}
.error{color:red;}
.toggle-btn{font-size:12px;padding:4px 8px;border-radius:6px;border:1px solid #ccc;background:#f8f8f8;cursor:pointer;}
small{color:#777;}
.map-link{font-size:12px;color:#2563eb;text-decoration:none;margin-left:6px;}
.map-link:hover{text-decoration:underline;}
</style>
</head>

<body>

<div class="header-info" id="dateInfo"></div>
<h2>711 é›™æ¨¡å‹å°ˆæ¥­ç‰ˆï½œå…¨å°é«˜çˆ¾å¤«çƒå ´ 7 æ—¥é å ±</h2>

<div class="model-buttons">
<button id="btnECMWF" class="active">ECMWF å°ˆæ¥­ç‰ˆ</button>
<button id="btnCWA">CWA å®˜æ–¹ç‰ˆ</button>
</div>

<div class="region-buttons" id="regionButtons"></div>
<div id="courses">è¼‰å…¥ä¸­...</div>

<script>

const API_KEY = "CWA-60E4630E-A677-453A-BD76-C74F148C86ED";
let currentModel="ECMWF";
let weatherCache={};

document.getElementById("dateInfo").innerText=
"æ›´æ–°æ™‚é–“ï¼š"+new Date().toLocaleString();

/* ===== æ˜ŸæœŸ ===== */
function getWeekday(dateStr){
const d=new Date(dateStr);
return ["é€±æ—¥","é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­"][d.getDay()];
}

/* ===== å…¨å°å®Œæ•´çƒå ´ï¼ˆç„¡åˆªæ¸›ï¼‰===== */
const courses = [

/* å°åŒ— / æ–°åŒ— */
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"ç¿¡ç¿ é«˜çˆ¾å¤«çƒå ´", city:"æ–°åŒ—å¸‚", lat:25.0679, lon:121.4543 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"é»ƒé‡‘æµ·å²¸ï¼ˆåŒ—æµ·ï¼‰é«˜çˆ¾å¤«çƒå ´", city:"æ–°åŒ—å¸‚", lat:25.2901, lon:121.5378 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"æ¿±æµ·é«˜çˆ¾å¤«ä¿±æ¨‚éƒ¨", city:"æ–°åŒ—å¸‚", lat:25.2517, lon:121.5195 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"å°ç£ï¼ˆè€æ·¡æ°´ï¼‰é«˜çˆ¾å¤«çƒå ´", city:"æ–°åŒ—å¸‚", lat:25.1964, lon:121.4415 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"å¤§å±¯é«˜çˆ¾å¤«çƒå ´", city:"æ–°åŒ—å¸‚", lat:25.2023, lon:121.5298 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"æ®çš‡ï¼ˆæ–°æ·¡æ°´ï¼‰é«˜çˆ¾å¤«çƒå ´", city:"æ–°åŒ—å¸‚", lat:25.2191, lon:121.4472 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"æ—å£é«˜çˆ¾å¤«çƒå ´", city:"æ–°åŒ—å¸‚", lat:25.0863, lon:121.3657 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"å…«é‡Œåœ‹éš›é«˜çˆ¾å¤«çƒå ´", city:"æ–°åŒ—å¸‚", lat:25.1427, lon:121.3998 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"ç¾éº—è¯é«˜çˆ¾å¤«çƒå ´", city:"æ–°åŒ—å¸‚", lat:25.1085, lon:121.5332 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"å¹¸ç¦é«˜çˆ¾å¤«çƒå ´", city:"æ–°åŒ—å¸‚", lat:25.1815, lon:121.4376 },
{ region:"å°åŒ—å¸‚ / æ–°åŒ—å¸‚", name:"æ±è¯é«˜çˆ¾å¤«çƒå ´", city:"æ–°åŒ—å¸‚", lat:25.0962, lon:121.6033 },

/* æ¡ƒåœ’ */
{ region:"æ¡ƒåœ’", name:"å°åŒ—é«˜çˆ¾å¤«çƒå ´", city:"æ¡ƒåœ’å¸‚", lat:25.0124, lon:121.3005 },
{ region:"æ¡ƒåœ’", name:"çµ±å¸¥é«˜çˆ¾å¤«çƒå ´", city:"æ¡ƒåœ’å¸‚", lat:24.9967, lon:121.2831 },
{ region:"æ¡ƒåœ’", name:"é•·åºšé«˜çˆ¾å¤«çƒå ´", city:"æ¡ƒåœ’å¸‚", lat:25.0582, lon:121.3869 },
{ region:"æ¡ƒåœ’", name:"æ±æ–¹é«˜çˆ¾å¤«çƒå ´", city:"æ¡ƒåœ’å¸‚", lat:24.9463, lon:121.2924 },
{ region:"æ¡ƒåœ’", name:"ç¬¬ä¸€é«˜çˆ¾å¤«çƒå ´", city:"æ¡ƒåœ’å¸‚", lat:24.9538, lon:121.2437 },
{ region:"æ¡ƒåœ’", name:"æ°¸æ¼¢é«˜çˆ¾å¤«çƒå ´", city:"æ¡ƒåœ’å¸‚", lat:24.8942, lon:121.2715 },
{ region:"æ¡ƒåœ’", name:"æ¡ƒåœ’é«˜çˆ¾å¤«çƒå ´", city:"æ¡ƒåœ’å¸‚", lat:25.0247, lon:121.2859 },
{ region:"æ¡ƒåœ’", name:"å¤§æºªé«˜çˆ¾å¤«çƒå ´", city:"æ¡ƒåœ’å¸‚", lat:24.8837, lon:121.2806 },
{ region:"æ¡ƒåœ’", name:"é¾æ½­é«˜çˆ¾å¤«çƒå ´", city:"æ¡ƒåœ’å¸‚", lat:24.8634, lon:121.2187 },
{ region:"æ¡ƒåœ’", name:"æšæ˜‡é«˜çˆ¾å¤«é„‰æ‘ä¿±æ¨‚éƒ¨", city:"æ¡ƒåœ’å¸‚", lat:24.8578, lon:121.1964 },

/* èŠ±æ± */
{ region:"èŠ±æ±", name:"ç¤æºªé«˜çˆ¾å¤«çƒå ´", city:"å®œè˜­ç¸£", lat:24.8124, lon:121.7501 },
{ region:"èŠ±æ±", name:"èŠ±è“®é«˜çˆ¾å¤«çƒå ´", city:"èŠ±è“®ç¸£", lat:23.9917, lon:121.6018 },

/* æ–°ç«¹ / è‹—æ — */
{ region:"æ–°ç«¹ / è‹—æ —", name:"å†èˆˆé«˜çˆ¾å¤«çƒå ´", city:"æ–°ç«¹ç¸£", lat:24.7893, lon:121.0234 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"æ–°ç«¹ï¼ˆæ–°è±ï¼‰é«˜çˆ¾å¤«çƒå ´", city:"æ–°ç«¹ç¸£", lat:24.8884, lon:120.9871 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"æ±æ–¹ä¹‹æ˜Ÿé«˜çˆ¾å¤«çƒå ´", city:"è‹—æ —ç¸£", lat:24.5418, lon:120.8724 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"ç«‹ç›Šé«˜çˆ¾å¤«çƒå ´", city:"è‹—æ —ç¸£", lat:24.5207, lon:120.8822 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"æ—­é™½é«˜çˆ¾å¤«çƒå ´", city:"è‹—æ —ç¸£", lat:24.4693, lon:120.8438 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"è€çˆºé—œè¥¿é«˜çˆ¾å¤«çƒå ´", city:"æ–°ç«¹ç¸£", lat:24.7986, lon:121.1777 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"å±±æºªåœ°é«˜çˆ¾å¤«çƒå ´", city:"è‹—æ —ç¸£", lat:24.4845, lon:120.9027 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"å¯¶å±±é«˜çˆ¾å¤«çƒå ´", city:"æ–°ç«¹ç¸£", lat:24.7422, lon:120.9853 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"çš‡å®¶é«˜çˆ¾å¤«çƒå ´", city:"è‹—æ —ç¸£", lat:24.6127, lon:120.8611 },
{ region:"æ–°ç«¹ / è‹—æ —", name:"å…¨åœ‹é«˜çˆ¾å¤«çƒå ´", city:"è‹—æ —ç¸£", lat:24.5754, lon:120.8149 },

/* å°ä¸­ / å½°åŒ– / å—æŠ• */
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", name:"æ¸…æ³‰å´—é«˜çˆ¾å¤«çƒå ´", city:"è‡ºä¸­å¸‚", lat:24.2102, lon:120.6041 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", name:"è±åŸé«˜çˆ¾å¤«çƒå ´", city:"è‡ºä¸­å¸‚", lat:24.2667, lon:120.7173 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", name:"å°ä¸­åœ‹éš›é«˜çˆ¾å¤«çƒå ´", city:"è‡ºä¸­å¸‚", lat:24.1715, lon:120.7276 },
{ region:"å°ä¸­ / å½°åŒ– / å—æŠ•", name:"éœ§å³°é«˜çˆ¾å¤«çƒå ´", city:"è‡ºä¸­å¸‚", lat:24.0641, lon:120.7009 },

/* å˜‰ç¾© / å°å— / é«˜é›„ / å±æ± */
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"æ£•æ¢ æ¹–ï¼ˆæ±æ´‹ï¼‰é«˜çˆ¾å¤«çƒå ´", city:"å˜‰ç¾©ç¸£", lat:23.4702, lon:120.4024 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"æ–‘èŠèŠ±é«˜çˆ¾å¤«ä¿±æ¨‚éƒ¨", city:"è‡ºå—å¸‚", lat:23.0168, lon:120.4057 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"å˜‰å…‰é«˜çˆ¾å¤«çƒå ´", city:"å˜‰ç¾©å¸‚", lat:23.4859, lon:120.4308 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"å°å—é«˜çˆ¾å¤«çƒå ´ï¼ˆæ–°åŒ–ï¼‰", city:"è‡ºå—å¸‚", lat:23.0384, lon:120.3205 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"å—ä¸€é«˜çˆ¾å¤«çƒå ´", city:"è‡ºå—å¸‚", lat:23.1438, lon:120.4037 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"å—å¯¶é«˜çˆ¾å¤«çƒå ´", city:"è‡ºå—å¸‚", lat:23.1025, lon:120.3268 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"å¤§å´—å±±é«˜çˆ¾å¤«çƒå ´", city:"é«˜é›„å¸‚", lat:22.8533, lon:120.3542 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"ä¿¡èª¼é«˜çˆ¾å¤«çƒå ´", city:"é«˜é›„å¸‚", lat:22.7245, lon:120.3894 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"è§€éŸ³å±±é«˜çˆ¾å¤«çƒå ´", city:"é«˜é›„å¸‚", lat:22.7416, lon:120.3557 },
{ region:"å˜‰ç¾© / å°å— / é«˜é›„ / å±æ±", name:"å±æ±é«˜çˆ¾å¤«çƒå ´", city:"å±æ±ç¸£", lat:22.6694, lon:120.4882 }

];

/* ===== æ¨¡å‹åˆ‡æ› ===== */
document.getElementById("btnECMWF").onclick=()=>{
currentModel="ECMWF";
setActive("btnECMWF");
reload();
};
document.getElementById("btnCWA").onclick=()=>{
currentModel="CWA";
setActive("btnCWA");
reload();
};

function setActive(id){
document.querySelectorAll(".model-buttons button").forEach(b=>b.classList.remove("active"));
document.getElementById(id).classList.add("active");
}

/* ===== ECMWF ===== */
async function getECMWF(lat,lon){
const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=precipitation_probability,precipitation,windspeed_10m,windgusts_10m&daily=temperature_2m_max,temperature_2m_min&forecast_days=7&timezone=Asia/Taipei`;

try{
const res=await fetch(url);
const data=await res.json();

const results=[];

for(let d=0;d<7;d++){

const date=data.daily.time[d];
const morning=[];
const afternoon=[];

data.hourly.time.forEach((t,i)=>{
if(t.startsWith(date)){
const h=parseInt(t.substring(11,13));
if(h>=8&&h<12) morning.push(i);
if(h>=12&&h<18) afternoon.push(i);
}
});

const avg=(arr,key)=>
arr.length?Math.round(arr.reduce((s,i)=>s+data.hourly[key][i],0)/arr.length):0;

results.push({
date,
weekday:getWeekday(date),
minT:data.daily.temperature_2m_min[d],
maxT:data.daily.temperature_2m_max[d],

popMorning:avg(morning,"precipitation_probability"),
popAfternoon:avg(afternoon,"precipitation_probability"),
rainMorning:avg(morning,"precipitation"),
rainAfternoon:avg(afternoon,"precipitation"),
windMorning:avg(morning,"windspeed_10m"),
windAfternoon:avg(afternoon,"windspeed_10m"),
gustMorning:avg(morning,"windgusts_10m"),
gustAfternoon:avg(afternoon,"windgusts_10m")
});
}

return results;
}catch(e){
return null;
}
}

/* ===== CWA è½‰æ—©æ™š ===== */
async function getCWA(city){

city=city.replace("å°","è‡º");

const url=`https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-D0047-091?Authorization=${API_KEY}&LocationName=${city}`;

try{
const res=await fetch(url);
const data=await res.json();
const loc=data.records.Locations[0].Location[0];

const weatherTimes=loc.WeatherElement.find(e=>e.ElementName==="å¤©æ°£ç¾è±¡").Time;
const popTimes=loc.WeatherElement.find(e=>e.ElementName==="12å°æ™‚é™é›¨æ©Ÿç‡").Time;
const maxT=loc.WeatherElement.find(e=>e.ElementName==="æœ€é«˜æº«åº¦").Time;
const minT=loc.WeatherElement.find(e=>e.ElementName==="æœ€ä½æº«åº¦").Time;

let daily={};

weatherTimes.forEach((w,i)=>{
const date=w.StartTime.substring(0,10);
if(!daily[date]){
daily[date]={
weather:w.ElementValue[0].Weather,
popMorning:0,
popAfternoon:0,
minT:parseInt(minT[i].ElementValue[0].MinTemperature),
maxT:parseInt(maxT[i].ElementValue[0].MaxTemperature)
};
}
const rain=parseInt(popTimes[i].ElementValue[0].ProbabilityOfPrecipitation);
const start=new Date(w.StartTime);
const end=new Date(w.EndTime);
const base=new Date(date+"T00:00:00");

const mStart=new Date(base);mStart.setHours(8);
const noon=new Date(base);noon.setHours(12);
const aEnd=new Date(base);aEnd.setHours(18);

if(start<noon && end>mStart) daily[date].popMorning=rain;
if(start<aEnd && end>noon) daily[date].popAfternoon=rain;

});

return Object.keys(daily).slice(0,7).map(date=>({
date,
weekday:getWeekday(date),
...daily[date]
}));

}catch(e){
return null;
}
}

/* ===== å€åŸŸæŒ‰éˆ• ===== */
function createRegionButtons(){
const regions=["å…¨éƒ¨",...new Set(courses.map(c=>c.region))];
const container=document.getElementById("regionButtons");
container.innerHTML="";
regions.forEach(r=>{
const btn=document.createElement("button");
btn.innerText=r;
btn.onclick=()=>render(r);
container.appendChild(btn);
});
container.firstChild.classList.add("active");
}

/* ===== è¼‰å…¥ ===== */
async function reload(){
weatherCache={};
document.getElementById("courses").innerHTML="è¼‰å…¥ä¸­...";

await Promise.all(
courses.map(async c=>{
if(currentModel==="ECMWF")
weatherCache[c.name]=await getECMWF(c.lat,c.lon);
else
weatherCache[c.name]=await getCWA(c.city);
})
);

createRegionButtons();
render("å…¨éƒ¨");
}

/* ===== æ¸²æŸ“çµ±ä¸€æ ¼å¼ ===== */
function render(filter){

let html="";
const filtered=filter==="å…¨éƒ¨"?courses:courses.filter(c=>c.region===filter);
const grouped=filtered.reduce((a,c)=>{
if(!a[c.region]) a[c.region]=[];
a[c.region].push(c);
return a;
},{});

for(const region in grouped){

html+=`<div class="region-title">${region}</div>`;

grouped[region].forEach((c,i)=>{

const data=weatherCache[c.name];
if(!data){
html+=`<div class="card"><strong>${c.name}</strong><div class="error">è®€å–å¤±æ•—</div></div>`;
return;
}

let forecastHTML="";
const cardId=`card_${region}_${i}`.replace(/\s/g,'');

data.forEach((f,index)=>{

const hidden=index>=2?"display:none;":"";

forecastHTML+=`
<div class="day-block extra-day" style="${hidden}">
<strong>${f.date}ï¼ˆ${f.weekday}ï¼‰</strong><br>
æº«åº¦ ${f.minT}Â°C - ${f.maxT}Â°C<br>

08â€“12ï½œ
â˜” ${f.rainMorning||"-"}mm (${f.popMorning||"-"}%)ï½œ
ğŸŒ¬ ${f.windMorning||"-"}km/hï½œ
ğŸ’¨ é™£é¢¨ ${f.gustMorning||"-"}<br>

12â€“18ï½œ
â˜” ${f.rainAfternoon||"-"}mm (${f.popAfternoon||"-"}%)ï½œ
ğŸŒ¬ ${f.windAfternoon||"-"}km/hï½œ
ğŸ’¨ é™£é¢¨ ${f.gustAfternoon||"-"}
</div>`;
});

forecastHTML+=`
<div style="text-align:right;margin-top:6px;">
<button class="toggle-btn" onclick="toggle('${cardId}',this)">å±•é–‹</button>
</div>`;

html+=`
<div class="card" id="${cardId}">
<strong>${c.name}</strong>
<a class="map-link" href="https://www.google.com/maps/search/?api=1&query=${c.lat},${c.lon}" target="_blank">ğŸ“ åœ°åœ–</a>
<a class="map-link" href="https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lon}" target="_blank">ğŸ§­ å°èˆª</a>
<br><small>${c.lat}, ${c.lon}</small>
${forecastHTML}
</div>`;
});
}

document.getElementById("courses").innerHTML=html;
}

/* ===== å±•é–‹ ===== */
function toggle(id,btn){
const card=document.getElementById(id);
const extra=card.querySelectorAll(".extra-day");
const hidden=extra[2]?.style.display==="none";
extra.forEach((d,i)=>{ if(i>=2)d.style.display=hidden?"block":"none"; });
btn.innerText=hidden?"æ”¶åˆ":"å±•é–‹";
}

reload();

</script>
</body>
</html>
